### **3 软件综述**

#### **3.1 软件应用**
本软件旨在为分布式应用提供一个自动化的部署与监控平台。它预期的用途是通过API接口集中管理和控制部署在多个服务器节点上的应用集合（任务包），从而替代繁琐的手动部署与监控流程。期望的能力、运行改进和受益情况包括：
* **提升效率**：通过预定义的"任务包"，实现复杂应用环境的一键部署。
* **保障一致性**：确保在不同节点上的部署配置和操作流程保持一致，减少因环境差异导致的问题。
* **集中监控**：提供统一的API接口，实时获取各节点资源占用及应用运行状态，简化运维监控。

#### **3.2 软件清单**
为使本软件正常运行，必须安装以下软件文件：

| 组件 | 文件/目录 | 描述 | 保密性与恢复 |
| :--- | :--- | :--- | :--- |
| **管理端** | `manager` | 主程序可执行文件。 | - |
| | `config.yaml` | Manager服务的配置文件。 | 可能包含敏感信息，需妥善保管。 |
| | `resource_monitor.db` | 存储所有任务组模板、节点信息和监控数据的数据库文件。 | **关键恢复文件**，需定期备份以防配置丢失。 |
| **代理端** | `agent` | 主程序可执行文件。 | - |
| | `config.yaml` | Agent服务的配置文件，包含Manager地址等。 | - |

#### **3.3 软件环境**
用户安装并运行该软件需满足以下软硬件及其他资源要求。

* **a) 计算机设备**：
    * **管理端节点**：
        * 操作系统：Linux (Ubuntu 20.04+, CentOS 7+)
        * 内存：建议最低 2 GB RAM
        * 磁盘空间：建议最低 10 GB 可用空间，用于存储日志和任务包数据库。
    * **代理端节点**：
        * 操作系统：Linux (Ubuntu 20.04+, CentOS 7+)
        * 内存：建议最低 1 GB RAM
        * 磁盘空间：取决于所部署应用的大小和数据需求。

* **b) 通信设备**：
    * Manager节点需要开放API服务端口（如 `8080/tcp`）给用户，并开放Agent通信端口（如 `8081/tcp`）给所有Agent节点。
    * 所有Agent节点必须能够通过网络访问Manager节点的通信端口。

* **c) 其他软件**：
    * 所有节点均需安装`systemd`或同类服务管理工具，以便将Manager和Agent作为后台服务运行。

#### **3.4 软件组织和操作概述**
从用户的角度，软件的组织与操作描述如下：

* **a) 软件逻辑部件**：
    * **管理端**：是系统的"大脑"。负责接收用户的API指令、管理任务包配置、向Agent下发指令并汇总所有节点的状态。
    * **代理端**：是系统的"手脚"。部署在每个工作节点上，负责执行Manager的指令（如启动/停止应用）、采集本节点的资源和应用状态并上报给Manager。

* **b) 性能特性**：
    * **API响应时间**：对于常规查询类API（如获取节点状态），典型响应时间在`200ms`以内。
    * **状态更新速率**：Agent默认每`30`秒向Manager上报一次心跳和状态数据。
    * **限制**：单个Manager实例理论上可管理最多`1000`个Agent节点。

* **d) 监控措施**：
    * 本软件的运行状态和错误信息会记录在日志文件中，用户可通过查看日志来进行监控和故障排查。

#### **3.5 意外事故及运行的备用状态和方式**
当某个Agent节点因网络故障或自身服务异常而与Manager失联时，Manager会将其标记为`offline`状态。在此备用状态下，用户将无法向该节点部署新任务，但系统的其他功能（如管理其他在线节点、查询历史数据等）不受影响。

#### **3.6 保密性**
与本软件相关的保密性考虑如下：
* **任务组配置**：任务组的定义可能包含文件路径、启动参数等敏感信息，请注意对数据库文件 `resource_monitor.db` 的访问控制。
* **非授权复制警告**：禁止对本软件或相关文档进行非授权的复制和分发。

#### **3.7 帮助和问题报告**
当您在使用中遇到问题时，请遵循以下规程报告问题：
* **联系方式**：通过电子邮件 `support@example.com` 或在项目工单系统 `https://issues.example.com` 中提交问题。
* **报告内容**：请在报告中提供以下信息：
    * 软件版本号（Manager和Agent）。
    * 问题发生时间。
    * 完整的API请求（路径、方法、请求体）和收到的响应。
    * 相关的Manager或Agent日志片段。

---

### **4 软件入门**

#### **4.1 软件的首次用户**

##### **4.1.1 熟悉设备**
由于本软件没有图形用户界面，其所有交互均通过命令行工具（如`curl`）或编程语言库发起API请求。因此，本节中关于物理设备（如屏幕、鼠标、键盘）的描述不适用。用户需要熟悉其选择的API客户端工具的使用。

##### **4.1.2 安装和设置**
请遵循以下规程在指定设备上安装和配置本软件。

**1. 安装管理端**：
1.  将`manager`可执行文件复制到服务器（例如 `/usr/local/bin/`）。
2.  （可选）配置`systemd`服务，使Manager能够开机自启并由系统管理。启动服务的具体命令和参数请参见 `4.2 启动` 章节。

**2. 安装代理端**：
1.  在所有工作节点上，将`agent`可执行文件复制到服务器。
2.  （可选）配置`systemd`服务，使Agent能够开机自启。启动服务的具体命令和参数请参见 `4.2 启动` 章节。

#### **4.2 启动**

请按以下步骤启动和验证本软件：

#### **1. 启动管理端（Manager）**

在Manager服务器上，打开命令行终端，进入可执行文件所在目录，执行如下命令：

```bash
./manager [--port <端口号>] [--db-path <数据库路径>] [--sftp-host <SFTP地址>] [--config <配置文件>] [--help]
```

**参数说明：**
- `--port <端口号>`：指定Manager对外提供API服务的HTTP端口，默认为`8080`。
- `--db-path <路径>`：指定SQLite数据库文件的存储路径，默认为`resource_monitor.db`。
- `--sftp-host <主机地址>`：指定用于文件分发的SFTP服务器地址，格式如`sftp://user:password@host:port/path/`。
  - **说明：** SFTP服务作为所有任务可执行文件的统一存储中心，所有需要分发到各节点运行的程序文件，必须提前上传到该SFTP目录下。系统在部署任务时会自动从SFTP拉取所需文件到目标节点的指定路径（如本地不存在时），确保任务能够顺利启动。**如果目标节点上已存在所需的可执行文件，则不会从SFTP拉取。**因此，如果所有任务都指定了节点且这些节点上已存在对应的可执行文件，则可以不依赖SFTP统一存储文件。建议为每个任务文件采用唯一且有意义的文件名，避免覆盖和混淆。SFTP服务需保证网络可达和账号权限正确。
- `--config <配置文件>`：指定JSON配置文件路径，默认为`manager_config.json`。
- `--help`：显示帮助信息并退出。

**配置文件示例（manager_config.json）：**
```json
{
  "port": 8080,
  "db_path": "resource_monitor.db",
  "sftp_host": "sftp://root:password@192.168.10.15:22/data/"
}
```

**示例：**
```bash
# 使用默认配置文件启动
./manager

# 指定自定义配置文件
./manager --config my_manager.json

# 命令行参数可覆盖配置文件内容
./manager --config my_manager.json --port 9090
```

**启动后：**
- 日志信息会直接输出到终端（屏幕），包括启动状态、错误提示等。
- 若启动成功，屏幕会显示如"Manager started on port 8080""Press Ctrl+C to stop..."等提示。
- 按下`Ctrl+C`可优雅关闭服务。

#### **2. 启动代理端（Agent）**

在每个工作节点服务器上，进入可执行文件所在目录，执行如下命令：

```bash
./agent [--manager-url <URL>] [--hostname <主机名>] [--network-interface <网卡名>] [--interval <秒数>] [--port <本地端口>] [--config <配置文件>] [--help]
```

**参数说明：**
- `--manager-url <URL>`：指定Manager服务的地址，默认为`http://localhost:8080`。
- `--hostname <主机名>`：覆盖Agent上报给Manager的主机名，默认为自动获取。
- `--network-interface <网卡名>`：指定用于上报的网络接口，默认为自动检测。
- `--interval <秒数>`：Agent采集并上报监控数据的间隔时间（秒），默认为`5`。
- `--port <本地端口>`：Agent本地HTTP服务端口，默认为`8081`。
- `--config <配置文件>`：指定JSON配置文件路径，默认为`agent_config.json`。
- `--help`：显示帮助信息并退出。

**配置文件示例（agent_config.json）：**
```json
{
  "manager_url": "http://localhost:8080",
  "hostname": "",
  "network_interface": "",
  "interval": 5,
  "port": 8081
}
```

**示例：**
```bash
# 使用默认配置文件启动
./agent

# 指定自定义配置文件
./agent --config my_agent.json

# 命令行参数可覆盖配置文件内容
./agent --config my_agent.json --manager-url http://192.168.1.100:8080
```

**启动后：**
- 日志信息会直接输出到终端（屏幕），包括启动状态、错误提示等。
- 若启动成功，屏幕会显示如"Press Ctrl+C to stop..."等提示。
- 按下`Ctrl+C`可优雅关闭服务。

#### **3. 验证系统状态**

1. **确认Manager和至少一个Agent服务已成功启动且没有报错退出。**
2. **使用curl工具发送API请求，验证系统连通性：**
    ```bash
    curl -X GET 'http://<manager_ip>:<port>/api/task/node'
    ```
    *请将 `<manager_ip>:<port>` 替换为Manager的实际地址和端口。*
3. **如果返回的JSON中包含已启动的Agent节点信息，则系统已准备就绪。**

**常见问题排查：**
- 连接被拒绝？→ 检查Manager服务是否运行，防火墙是否开放API端口。
- 节点列表为空或节点状态为offline？→ 检查Agent服务是否运行，并确认其`--manager-url`参数配置正确。

#### **4. 日志说明**

- 所有日志信息均直接输出到终端（屏幕），不再写入文件。
- 日志内容包含时间戳和日志级别，便于排查问题。

#### **4.3 停止和挂起**
软件的使用是通过API调用实现的，本身无"挂起"状态。停止软件运行指停止其后台服务。
* **停止服务**：使用系统命令（如 `systemctl stop manager` 或 `systemctl stop agent`）来停止服务进程。
* **判断正常停止**：如果服务正常停止，命令会无错误返回，进程会优雅退出（Exit Code 0），并且在日志中通常会记录"shutting down"等信息。

### **第5章 使用指南**

本章旨在为用户提供通过API（应用程序编程接口）使用本软件的详细规程。由于本软件没有图形用户界面，所有操作均通过API请求完成。本章主要围绕节点管理、任务管理和任务部署三大核心能力展开。

#### **5.1 能力**

本软件的核心能力是远程任务部署与监控，它由以下三种相互关联的能力构成：

* **节点管理**：Agent代理端持续采集各节点的资源数据并上报，Manager管理端负责汇总。用户可通过API查询这些数据，为任务部署决策提供依据。
* **任务管理**：用户可将一系列应用的运行方式定义为一个"任务组模板"，并将其配置存储在Manager端。这使得复杂的部署操作可以被预定义和复用。
* **任务部署**：用户通过API向Manager端下发指令，以运行预定义的任务组，并能持续监控任务的运行状态。

#### **5.2 约定**

本软件的API使用遵循以下通用约定：

* **请求格式**：所有API请求的主体（Body）和响应的主体均使用`JSON`格式。
* **HTTP动词**：
    * `GET`：用于获取资源（如节点列表）。
    * `POST`：用于创建新资源（如任务组模板），或执行操作（如查询、部署、停止）。
* **状态码**：响应中的HTTP状态码用于表示请求结果，如 `200 OK` 表示成功，`400 Bad Request` 表示请求参数错误，`404 Not Found` 表示资源不存在，`500 Internal Server Error` 表示服务器内部错误。

#### **5.3 处理规程**

本节将分功能详细描述各项操作的API规程。

##### **5.3.1 节点管理**

**1. 查询节点列表**
* **描述**：获取所有已注册的计算节点及其当前的资源使用情况。
* **接口**：`GET /api/task/node`
* **请求示例**：无请求体。
* **响应示例 (Output)**：
    ```json
    {
      "nodes": [
        {
          "ip": "192.168.1.100",
          "status": 0,
          "resources": "cpu_usage_percent:50,memory_usage_percent:30"
        },
        {
          "ip": "192.168.1.101",
          "status": 1,
          "resources": "cpu_usage_percent:0,memory_usage_percent:0"
        }
      ]
    }
    ```
* **注意**：`status` 字段中, `0` 代表节点在线, `1` 代表节点离线。

##### **5.3.2 任务管理**

**1. 创建任务组模板**
* **描述**：定义一个新的任务组模板，包含名称和需要执行的任务列表。配置将被存储在Manager本地。
* **接口**：`POST /api/task/task_group`
* **输入 (Input)**：
    ```json
    {
      "name": "我的数据处理任务",
      "task_groups": [
        {
          "tasks": [
            {
              "name": "数据清洗器",
              "config": {
                "command": "192.168.10.100:/opt/apps/clean.sh"
              }
            },
            {
              "name": "数据分析器",
              "config": {
                "command": "/opt/apps/analyze.py"
              }
            }
          ]
        }
      ]
    }
    ```
* **响应示例 (Output)**：
    ```json
    {
      "status": "success"
    }
    ```

**2. 查询任务组模板**
* **描述**：根据名称查询一个已创建的任务组模板的详细信息。
* **接口**：`POST /api/task/query`
* **输入 (Input)**：
    ```json
    {
      "name": "我的数据处理任务"
    }
    ```
* **响应示例 (Output)**：
    ```json
    {
      "name": "我的数据处理任务",
      "task_groups": [
        {
          "tasks": [
            {
              "name": "数据清洗器",
              "config": {
                "command": "/opt/apps/clean.sh"
              }
            },
            {
              "name": "数据分析器",
              "config": {
                "command": "/opt/apps/analyze.py"
              }
            }
          ]
        }
      ]
    }
    ```

##### **5.3.3 任务部署与监控**

**1. 部署任务组**
* **描述**：根据指定的任务组模板名称，部署一个新的任务组实例。
* **接口**：`POST /api/task/task_group/deploy`
* **输入 (Input)**：
    ```json
    {
      "name": "我的数据处理任务"
    }
    ```
* **响应示例 (Output)**：返回一个部署ID，用于后续状态跟踪。
    ```json
    {
      "id": "generated-business-instance-uuid"
    }
    ```

**2. 查询任务组状态**
* **描述**：根据任务组实例ID查询其运行状态。
* **接口**：`POST /api/task/task_group/query`
* **输入 (Input)**：
    ```json
    {
      "id": "business-instance-uuid"
    }
    ```
* **响应示例 (Output)**：
    ```json
    {
      "id": "business-instance-uuid",
      "status": 0
    }
    ```
* **注意**: `status` 字段中, `0` 代表正在运行, `1` 代表已停止或存在异常。

**3. 停止任务组**
* **描述**：根据任务组实例ID停止并删除一个正在运行的任务组。
* **接口**：`POST /api/task/task_group/stop`
* **输入 (Input)**：
    ```json
    {
      "id": "business-instance-uuid"
    }
    ```
* **响应示例 (Output)**：
    ```json
    {
      "id": "business-instance-uuid"
    }
    ```

#### **5.4 有关的处理**

本软件的运行依赖于在各工作节点上以后台或服务形式运行的Agent进程。用户无需直接与Agent交互，其主要职责包括：
* **心跳与资源上报**：定期向Manager发送心跳包，并上报节点当前的CPU、内存、磁盘等资源使用情况。
* **指令执行**：接收并执行来自Manager的任务部署指令，启动或停止指定的应用进程。
* **状态监控**：监控由其启动的应用进程的运行状态（如PID、CPU占用、是否存活），并将状态变化上报给Manager。

用户的责任是确保Agent服务在所有工作节点上正确安装、配置并保持运行。

#### **5.5 数据备份**

为防止配置丢失，应定期备份存储任务组模板等配置的数据。这些配置默认存储在Manager配置文件中指定的数据库文件路径（例如 `resource_monitor.db`）。请使用标准的系统工具（如 `cp`、`rsync`）或备份软件对此文件进行备份。

#### **5.6 错误、故障和紧急情况下的恢复**

* **Manager服务中断**：若Manager服务崩溃或服务器重启，请重新启动Manager服务。服务启动后将自动恢复状态。
* **Agent节点离线**：若某个节点在资源列表中显示为`offline`，请检查该节点的网络连接以及Agent服务的运行状态。通常需要登录到该节点，检查服务日志并尝试重启Agent服务。
* **任务执行失败**：若部署状态显示为`FAILED`，请通过 `GET /deployments/{deployment_id}` 接口查看具体哪个应用的`exit_code`非0，并结合应用自身的日志进行排错。

#### **5.7 消息**

通过API交互时，可能会收到以下常见的错误消息或状态码。
| HTTP状态码 | 消息体示例 (JSON) | 含义及建议操作 |
| :--- | :--- | :--- |
| `400 Bad Request` | `{"error": "Invalid request format"}` | 请求的格式或参数有误。请检查API文档，修正请求参数。 |
| `404 Not Found` | `{"error": "Business template not found"}` | 请求的资源（如任务组模板）不存在。请确认名称或ID是否正确。 |

#### **5.8 快速参考指南**

下表概括了本软件最常用的API功能。

| 功能 | HTTP方法与路径 | 描述 |
| :--- | :--- | :--- |
| **查询节点列表** | `GET /api/task/node` | 获取所有节点及其资源状态。 |
| **创建任务组模板** | `POST /api/task/task_group` | 定义一个新的可部署任务组模板。 |
| **查询任务组模板** | `POST /api/task/query` | 根据名称查询任务组模板。 |
| **部署任务组** | `POST /api/task/task_group/deploy` | 根据模板名称部署一个任务组实例。 |
| **查询任务组状态** | `POST /api/task/task_group/query` | 根据ID查询一个部署实例的实时状态。 |
| **停止任务组** | `POST /api/task/task_group/stop` | 根据ID停止一个正在运行的部署实例。 |

---

### **5.9 /api/task相关接口字段与功能说明**

#### 1. `GET /api/task/node` —— 查询节点列表
**功能**：
- 获取所有已注册节点及其资源使用情况。
- 用于展示当前集群中所有Agent节点的在线/离线状态、IP地址、CPU和内存等资源占用。
- 典型用法：
  - 管理员或前端页面定时调用，实时展示节点健康状况。
  - 部署任务前，评估各节点的资源负载，辅助调度决策。
- 能实现的目标：
  - 快速定位离线或高负载节点。
  - 为任务分配选择合适的节点。

**响应字段说明：**
| 字段         | 类型     | 说明                                                         |
|--------------|----------|--------------------------------------------------------------|
| nodes        | array    | 节点信息列表，每个元素为一个节点对象                         |
| └─ ip        | string   | 节点的IP地址                                                 |
| └─ status    | int      | 节点状态，0=在线，1=离线                                     |
| └─ resources | string   | 节点资源使用情况，格式如`cpu_usage_percent:50,memory_usage_percent:30` |

---

#### 2. `POST /api/task/task_group` —— 创建任务组模板
**功能**：
- 定义一个新的任务组模板，包含名称和需要执行的任务列表。
- 典型用法：
  - 用户通过前端或API上传一组任务配置，批量保存为模板，便于后续多次复用。
  - 支持指定任务运行的节点亲和性（通过command字段的ip:binary_path格式）。
- 能实现的目标：
  - 实现复杂应用环境的一键部署。
  - 保证多节点多任务部署的一致性和自动化。

**请求字段说明：**
| 字段         | 类型     | 说明                                                         |
|--------------|----------|--------------------------------------------------------------|
| name         | string   | 任务组模板名称                                               |
| task_groups  | array    | 任务组列表（目前仅支持一个任务组，保留数组结构以便扩展）     |
| └─ tasks     | array    | 任务列表，每个元素为一个任务对象                             |
|    └─ name   | string   | 任务名称                                                     |
|    └─ config | object   | 任务配置                                                     |
|       └─ command | string | 启动命令，格式为`[ip:]<binary_path>`，如`192.168.1.100:/bin/agent`或`/bin/agent` |

**响应字段说明：**
| 字段   | 类型   | 说明           |
|--------|--------|----------------|
| status | string | 操作结果，通常为`success` |

---

#### 3. `POST /api/task/query` —— 查询任务组模板
**功能**：
- 根据名称查询一个已创建的任务组模板的详细信息。
- 典型用法：
  - 用户在部署前，回显/校验任务组模板的具体内容。
  - 前端页面展示所有任务组模板的结构和参数。
- 能实现的目标：
  - 确认模板内容是否符合预期。
  - 支持模板的版本管理和复用。

**请求字段说明：**
| 字段 | 类型   | 说明           |
|------|--------|----------------|
| name | string | 任务组模板名称 |

**响应字段说明：**
| 字段         | 类型     | 说明                                                         |
|--------------|----------|--------------------------------------------------------------|
| name         | string   | 任务组模板名称                                               |
| task_groups  | array    | 任务组列表                                                   |
| └─ tasks     | array    | 任务列表                                                     |
|    └─ name   | string   | 任务名称                                                     |
|    └─ config | object   | 任务配置                                                     |
|       └─ command | string | 启动命令（注意：此处返回的command通常不带ip，仅为binary_path） |

---

#### 4. `POST /api/task/task_group/deploy` —— 部署任务组
**功能**：
- 根据指定的任务组模板名称，部署一个新的任务组实例。
- 典型用法：
  - 用户选择一个已保存的模板，发起部署请求，系统自动分配并下发任务到各节点。
  - 支持批量部署、自动化运维。
- 能实现的目标：
  - 快速上线一组应用或服务。
  - 保证部署过程的标准化和可追溯。

**详细说明：**
- 当任务组模板中的任务指定了节点（即`command`字段为`ip:binary_path`格式），系统会将该任务下发到指定的目标节点，并在该节点上运行配置路径下的程序。
- 如果任务未指定节点（即`command`仅为`binary_path`），系统会根据各节点的当前负载情况，自动选择最合适的节点进行部署，实现资源的动态均衡分配。
- 在任务部署前，系统会检查目标节点的配置路径下是否已存在所需的可执行文件：
  - 如果文件已存在，则直接运行。
  - 如果文件不存在，则系统会通过SFTP服务从中心服务器拉取所需的可执行文件到本地指定路径，然后再运行。
  - 注意：SFTP服务的目录中必须提前上传好所需的可执行文件，否则任务部署会失败。
- 该接口支持批量部署多个任务，能够实现一键多节点多任务的自动化上线。

**请求字段说明：**
| 字段 | 类型   | 说明           |
|------|--------|----------------|
| name | string | 任务组模板名称 |

**响应字段说明：**
| 字段 | 类型   | 说明                       |
|------|--------|----------------------------|
| id   | string | 部署实例ID（UUID格式）     |

---

#### 5. `POST /api/task/task_group/query` —— 查询任务组状态
**功能**：
- 根据任务组实例ID查询其运行状态。
- 典型用法：
  - 部署后，用户通过该接口轮询或查询任务组的实时运行状态。
  - 前端页面展示任务组的健康状况和进度。
- 能实现的目标：
  - 实时监控任务组的生命周期。
  - 及时发现异常或失败的任务。

**请求字段说明：**
| 字段 | 类型   | 说明           |
|------|--------|----------------|
| id   | string | 部署实例ID     |

**响应字段说明：**
| 字段   | 类型   | 说明                                   |
|--------|--------|----------------------------------------|
| id     | string | 部署实例ID                             |
| status | int    | 运行状态，0=运行中，1=已停止或异常     |

---

#### 6. `POST /api/task/task_group/stop` —— 停止任务组
**功能**：
- 根据任务组实例ID停止并删除一个正在运行的任务组。
- 典型用法：
  - 用户主动停止不再需要的任务组，释放资源。
  - 运维人员在发现异常时，强制终止相关任务。
- 能实现的目标：
  - 动态管理和回收集群资源。
  - 保证系统的高可用和安全。

**请求字段说明：**
| 字段 | 类型   | 说明           |
|------|--------|----------------|
| id   | string | 部署实例ID     |

**响应字段说明：**
| 字段 | 类型   | 说明           |
|------|--------|----------------|
| id   | string | 部署实例ID     |