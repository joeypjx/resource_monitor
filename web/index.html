<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部署与资源管理运维软件</title>
    <link href="css/tailwind.min.css" rel="stylesheet">
    <link href="css/all.min.css" rel="stylesheet">
    <link href="css/webfonts/fa-solid-900.woff2" rel="preload" as="font" type="font/woff2" crossorigin>
    <link href="css/webfonts/fa-regular-400.woff2" rel="preload" as="font" type="font/woff2" crossorigin>
    <link href="css/webfonts/fa-brands-400.woff2" rel="preload" as="font" type="font/woff2" crossorigin>
    <style>
        body { 
            font-family: 'Courier New', 'Monaco', 'Consolas', monospace; 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #00ff00;
        }
        .modal { display: none; }
        .modal.active { display: flex; }
        /* Custom scrollbar for military style */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #00ff00; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #00cc00; }
        .table-responsive { overflow-x: auto; }
        .selected-business-item { background-color: #1a3a1a; /* military green */ }
        .config-type-fields { display: none; } /* Initially hide type-specific fields */

        /* Larger modal for lists */
        #listModal .modal-content {
            max-width: 80vw; /* Wider modal */
            max-height: 85vh; /* Taller modal */
        }
        .key-value-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .button-loading {
            position: relative;
            pointer-events: none; /* Disable clicks when loading */
            color: transparent !important; /* Hide text */
        }
        .button-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 16px;
            height: 16px;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #00ff00; /* Military green spinner */
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Military style overrides */
        .bg-white { background-color: #1a1a1a !important; color: #00ff00 !important; }
        .bg-gray-100 { background-color: #2d2d2d !important; }
        .bg-gray-50 { background-color: #2d2d2d !important; }
        .text-gray-800 { color: #00ff00 !important; }
        .text-gray-700 { color: #00ff00 !important; }
        .text-gray-600 { color: #00cc00 !important; }
        .text-gray-500 { color: #00aa00 !important; }
        .border-gray-300 { border-color: #00ff00 !important; }
        .border-gray-200 { border-color: #00ff00 !important; }
        .hover\:bg-blue-50:hover { background-color: #1a3a1a !important; }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 255, 0, 0.3) !important; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 255, 0, 0.3) !important; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 255, 0, 0.3) !important; }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 255, 0, 0.3) !important; }
        .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0, 255, 0, 0.3) !important; }
    </style>
</head>
<body>



    <main class="h-screen" id="mainContent">
    </main>

    <div id="genericModal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-50">
        <div class="modal-content bg-black border border-green-500 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-xl font-semibold text-green-500">Modal Title</h2>
                <button onclick="app.closeModal()" class="text-green-500 hover:text-green-300 text-2xl">&times;</button>
            </div>
            <div id="modalBody">
            </div>
            <div id="modalFooter" class="mt-6 flex justify-end space-x-3">
            </div>
        </div>
    </div>

    <div id="listModal" class="modal fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-40"> 
        <div class="modal-content bg-black border border-green-500 rounded-lg shadow-xl p-6 w-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="listModalTitle" class="text-xl font-semibold text-green-500">List Modal Title</h2>
                <button onclick="app.closeListModal()" class="text-green-500 hover:text-green-300 text-2xl">&times;</button>
            </div>
            <div id="listModalBody">
            </div>
            <div id="listModalFooter" class="mt-6 flex justify-end space-x-3">
                 <button onclick="app.closeListModal()" class="bg-green-600 hover:bg-green-700 text-black px-4 py-2 rounded-md border border-green-400">关闭</button>
            </div>
        </div>
    </div>


    <div id="notificationArea" class="fixed bottom-5 right-5 z-[100]">
    </div>


    <script>
        // --- Application Logic ---
        const app = {
            currentView: 'deployedBusinesses',
            selectedBusinessId: null,
            apiUrlPrefix: '/api', 
            mockData: { 
                deployedBusinesses: [],
                servers: [],
                componentTemplates: [],
                businessTemplates: []
            },
            autoRefreshInterval: null,  // 添加自动刷新间隔变量
            autoRefreshEnabled: true,  // 添加自动刷新开关
            refreshInterval: 5000,     // 默认5秒刷新一次

            // --- Utility Functions ---
            showNotification(message, type = 'success') {
                const area = document.getElementById('notificationArea');
                const notification = document.createElement('div');
                notification.className = `p-3 rounded-lg shadow-md mb-2 text-white ${type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500')}`;
                notification.textContent = message;
                area.appendChild(notification);
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            },

            // --- Mock Fetch for API simulation ---
            async mockFetch(url, options = {}) {
                console.log('Mock Fetch:', url, options);
                const method = options.method || 'GET'; 

                // Initialize mock data if empty for GET lists
                if (url === `${this.apiUrlPrefix}/templates/components` && method === 'GET' && this.mockData.componentTemplates.length === 0) {
                     this.mockData.componentTemplates.push(
                        { component_template_id: "ct-init-001", template_name: "初始Docker组件", type: "docker", description: "Nginx初始镜像", config: { image_url: "nginx:stable", image_name: "nginx", environment_variables: { TEST: "true" } }, created_at: "2024-06-05T00:00:00Z", updated_at: "2024-06-05T01:00:00Z" },
                        { component_template_id: "ct-init-002", template_name: "初始Binary组件", type: "binary", description: "基础二进制程序", config: { binary_path: "/usr/bin/myapp", environment_variables: { DEBUG: "1" }, affinity: {"hostname":"worker-node"} }, created_at: "2024-06-05T01:30:00Z", updated_at: "2024-06-05T01:35:00Z" }
                     );
                }
                if (url === `${this.apiUrlPrefix}/templates/businesses` && method === 'GET' && this.mockData.businessTemplates.length === 0) {
                    this.mockData.businessTemplates.push(
                        { business_template_id: "bt-init-001", template_name: "初始Web业务模板", description: "一个包含Nginx的Web应用", components: [{ component_template_id: "ct-init-001" }], created_at: "2024-06-05T02:00:00Z", updated_at: "2024-06-05T02:10:00Z" }
                    );
                }
                 if (url === `${this.apiUrlPrefix}/nodes` && method === 'GET' && this.mockData.servers.length === 0) {
                    this.mockData.servers.push(
                        { node_id: "node-0a00ae17-45ec-4dd1-9155-dc76cce95ff6", hostname: "d621f85f514f", ip_address: "172.17.0.2", status: "online", cpu_model: "Intel Core i7-8750H", gpu_count: 1, os_info: "Ubuntu 22.04 LTS", created_at: 1749055176, updated_at: 1749055311, latest_cpu: { core_count: 6, load_avg_1m: 0.5, load_avg_5m: 0.4, load_avg_15m: 0.3, timestamp: 1749055310, usage_percent: 25.5 }, latest_memory: { total: 16*1024*1024*1024, used: 4*1024*1024*1024, free: 12*1024*1024*1024, usage_percent: 25.0, timestamp: 1749055310 }},
                        { node_id: "node-1b2c3d4e-5f6a-7b8c-9d0e-1f2a3b4c5d6e", hostname: "worker-bee-01", ip_address: "192.168.1.105", status: "offline", cpu_model: "AMD Ryzen 5 5600X", gpu_count: 0, os_info: "Debian 12", created_at: 1749055000, updated_at: 1749055200, latest_cpu: { core_count: 6, load_avg_1m: 0.1, load_avg_5m: 0.2, load_avg_15m: 0.25, timestamp: 1749055195, usage_percent: 10.0 }, latest_memory: { total: 32*1024*1024*1024, used: 8*1024*1024*1024, free: 24*1024*1024*1024, usage_percent: 25.0, timestamp: 1749055195 }}
                    );
                }
                 if (url === `${this.apiUrlPrefix}/businesses/` && method === 'GET' && this.mockData.deployedBusinesses.length === 0) {
                    this.mockData.deployedBusinesses.push({
                        business_id: "b-sim-001",
                        business_name: "模拟部署业务-1",
                        created_at: Math.floor(Date.now() / 1000) - 3600, 
                        status: "running",
                        updated_at: Math.floor(Date.now() / 1000) - 600 
                    });
                     this.mockData.deployedBusinesses.push({
                        business_id: "b-sim-002",
                        business_name: "模拟部署业务-2 (已停止)",
                        created_at: Math.floor(Date.now() / 1000) - 7200, 
                        status: "stopped",
                        updated_at: Math.floor(Date.now() / 1000) - 1200 
                    });
                }


                return new Promise((resolve, reject) => {
                    setTimeout(() => { 
                        try {
                            // --- Component Templates ---
                            if (url === `${this.apiUrlPrefix}/templates/components` && method === 'POST') {
                                const body = JSON.parse(options.body);
                                const newId = 'ct-' + crypto.randomUUID().slice(0, 8);
                                const newTemplate = { ...body, component_template_id: newId, created_at: new Date().toISOString(), updated_at: new Date().toISOString() };
                                resolve({ ok: true, status: 201, json: async () => ({ status: "success", component_template_id: newId, message: "应用模板创建成功 (模拟)", template: newTemplate }) });
                            }
                            else if (url.startsWith(`${this.apiUrlPrefix}/templates/components/`) && method === 'PUT') {
                                const body = JSON.parse(options.body);
                                const id = url.split('/').pop();
                                const existingTemplateIndex = this.mockData.componentTemplates.findIndex(t => t.component_template_id === id);
                                if (existingTemplateIndex === -1) return resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "Component template not found" }) });
                                const updatedTemplate = { ...this.mockData.componentTemplates[existingTemplateIndex], ...body, component_template_id: id, updated_at: new Date().toISOString() };
                                resolve({ ok: true, status: 200, json: async () => ({ status: "success", component_template_id: id, message: "应用模板更新成功 (模拟)", template: updatedTemplate }) });
                            }
                            else if (url === `${this.apiUrlPrefix}/templates/components` && method === 'GET') {
                                resolve({ ok: true, status: 200, json: async () => ({ status: "success", templates: [...this.mockData.componentTemplates] }) });
                            }
                            else if (url.startsWith(`${this.apiUrlPrefix}/templates/components/`) && method === 'GET') { 
                                const id = url.split('/').pop();
                                const template = this.mockData.componentTemplates.find(t => t.component_template_id === id);
                                if (template) resolve({ ok: true, status: 200, json: async () => ({ status: "success", template: {...template} }) });
                                else resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "应用模板未找到" }) });
                            }
                            else if (url.startsWith(`${this.apiUrlPrefix}/templates/components/`) && method === 'DELETE') {
                                const id = url.split('/').pop();
                                const index = this.mockData.componentTemplates.findIndex(t => t.component_template_id === id);
                                if (index > -1) resolve({ ok: true, status: 200, json: async () => ({ status: "success", message: "应用模板删除成功" }) });
                                else resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "应用模板未找到" }) });
                            }
                            // --- Business Templates ---
                            else if (url === `${this.apiUrlPrefix}/templates/businesses` && method === 'POST') {
                                const body = JSON.parse(options.body);
                                const newId = 'bt-' + crypto.randomUUID().slice(0, 8);
                                const newTemplate = { ...body, business_template_id: newId, created_at: new Date().toISOString(), updated_at: new Date().toISOString() };
                                resolve({ ok: true, status: 201, json: async () => ({ status: "success", business_template_id: newId, message: "业务模板创建成功 (模拟)", template: newTemplate }) });
                            }
                            else if (url.startsWith(`${this.apiUrlPrefix}/templates/businesses/`) && method === 'PUT') {
                                const body = JSON.parse(options.body);
                                const id = url.split('/').pop();
                                const existingTemplateIndex = this.mockData.businessTemplates.findIndex(t => t.business_template_id === id);
                                if (existingTemplateIndex === -1) return resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "任务模板未找到" }) });
                                const updatedTemplate = { ...this.mockData.businessTemplates[existingTemplateIndex], ...body, business_template_id: id, updated_at: new Date().toISOString() };
                                resolve({ ok: true, status: 200, json: async () => ({ status: "success", business_template_id: id, message: "业务模板更新成功 (模拟)", template: updatedTemplate }) });
                            }
                            else if (url === `${this.apiUrlPrefix}/templates/businesses` && method === 'GET') {
                                resolve({ ok: true, status: 200, json: async () => ({ status: "success", templates: [...this.mockData.businessTemplates] }) });
                            }
                            else if (url.startsWith(`${this.apiUrlPrefix}/templates/businesses/`) && method === 'GET' && !url.includes('/as-business') && !url.endsWith('/template') && url.split('/').length === 4) { 
                                const id = url.split('/').pop();
                                const template = this.mockData.businessTemplates.find(t => t.business_template_id === id);
                                if (template) {
                                    const componentsWithDetails = template.components.map(compRef => {
                                        const compTpl = this.mockData.componentTemplates.find(ct => ct.component_template_id === compRef.component_template_id);
                                        return { ...compRef, template_details: compTpl ? {...compTpl} : null };
                                    });
                                    resolve({ ok: true, status: 200, json: async () => ({ status: "success", template: {...template, components: componentsWithDetails} }) });
                                } else {
                                    resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "任务模板未找到" }) });
                                }
                            }
                            else if (url.startsWith(`${this.apiUrlPrefix}/templates/businesses/`) && method === 'DELETE') { 
                                const id = url.split('/').pop();
                                const index = this.mockData.businessTemplates.findIndex(t => t.business_template_id === id);
                                if (index > -1) {
                                    resolve({ ok: true, status: 200, json: async () => ({ status: "success", message: "任务模板删除成功" }) });
                                } else {
                                    resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "任务模板未找到" }) });
                                }
                            }
                            else if (url.includes('/as-business') && method === 'GET') { 
                                const id = url.split('/')[3]; 
                                const businessTemplate = this.mockData.businessTemplates.find(t => t.business_template_id === id);
                                if (!businessTemplate) {
                                    return resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "任务模板未找到" }) });
                                }
                                const deployableComponents = businessTemplate.components.map(tc => {
                                    const compTpl = this.mockData.componentTemplates.find(ct => ct.component_template_id === tc.component_template_id);
                                    if (!compTpl) return null;
                                    return { component_id: compTpl.component_template_id, component_name: compTpl.template_name, type: compTpl.type, ...compTpl.config };
                                }).filter(c => c !== null);
                                resolve({
                                    ok: true, status: 200,
                                    json: async () => ({ status: "success", business: { business_name: businessTemplate.template_name, components: deployableComponents } })
                                });
                            }
                            // --- Deployed Businesses ---
                            else if (url.endsWith('/api/businesses/') && method === 'GET') { 
                                resolve({ ok: true, status: 200, json: async () => ({ status: "success", businesses: [...this.mockData.deployedBusinesses] }) });
                            }
                            else if (url.startsWith(`${this.apiUrlPrefix}/businesses/`) && method === 'GET' && !url.includes('/stop') && !url.includes('/restart') && !url.includes('/template/')) { 
                                const id = url.split('/').pop();
                                let business = this.mockData.deployedBusinesses.find(b => b.business_id === id);
                                if (business) {
                                    const detailedBusiness = JSON.parse(JSON.stringify(business)); // Deep copy
                                    if (!detailedBusiness.components) { // Simulate fetching components if not present
                                        detailedBusiness.components = [
                                            { component_id: "comp-sim-1-" + id.slice(0,4), component_name: "Simulated Component 1 for " + detailedBusiness.business_name , type: "docker", status: detailedBusiness.status, node_id: "node-sim", container_id: "container-sim-1", affinity: {}, environment_variables: { FOO: "BAR" }, started_at: detailedBusiness.created_at, updated_at: detailedBusiness.updated_at },
                                            { component_id: "comp-sim-2-" + id.slice(0,4), component_name: "Simulated Component 2 for " + detailedBusiness.business_name, type: "binary", status: detailedBusiness.status, node_id: "node-sim", process_id: "proc-sim-2", affinity: {}, environment_variables: { BA_Z: "QUX" }, started_at: detailedBusiness.created_at, updated_at: detailedBusiness.updated_at }
                                        ];
                                    }
                                    resolve({ ok: true, status: 200, json: async () => ({ status: "success", business: detailedBusiness }) });
                                } else {
                                    resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "任务未找到" }) });
                                }
                            }
                            else if (url.includes('/template/') && method === 'POST') { 
                                const templateId = url.split('/template/').pop();
                                const businessTemplate = this.mockData.businessTemplates.find(t => t.business_template_id === templateId);
                                if (!businessTemplate) return resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "任务模板未找到，无法部署" }) });
                                
                                const newBusinessId = 'b-' + crypto.randomUUID().slice(0,8);
                                const newDeployedBusiness = {
                                    business_id: newBusinessId,
                                    business_name: `${businessTemplate.template_name} - Deployed ${new Date().toLocaleTimeString()}`,
                                    created_at: Math.floor(Date.now() / 1000),
                                    status: "pending", // Will be updated by deploy simulation
                                    updated_at: Math.floor(Date.now() / 1000),
                                    components: [] // Components would be derived by backend
                                };
                                this.mockData.deployedBusinesses.push(newDeployedBusiness);
                                resolve({ ok: true, status: 200, json: async () => ({ status: "success", message: "任务已成功从模板部署 (模拟)", business_id: newBusinessId }) });
                            }
                             else if (url.includes('/stop') && method === 'POST') {
                                const id = url.split('/')[3];
                                const business = this.mockData.deployedBusinesses.find(b => b.business_id === id);
                                if (business) {
                                    resolve({ ok: true, status: 200, json: async () => ({ status: "success", message: "任务已成功停止" }) });
                                } else {
                                     resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "任务未找到" }) });
                                }
                            }
                            else if (url.includes('/restart') && method === 'POST') {
                                 const id = url.split('/')[3];
                                const business = this.mockData.deployedBusinesses.find(b => b.business_id === id);
                                if (business) {
                                    resolve({ ok: true, status: 200, json: async () => ({ status: "success", message: "任务已重启" }) });
                                } else {
                                     resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "任务未找到" }) });
                                }
                            }
                            else if (url.startsWith(`${this.apiUrlPrefix}/businesses/`) && method === 'DELETE') {
                                const id = url.split('/').pop();
                                const index = this.mockData.deployedBusinesses.findIndex(b => b.business_id === id);
                                if (index > -1) {
                                    resolve({ ok: true, status: 200, json: async () => ({ status: "success", message: "任务已成功删除" }) });
                                } else {
                                    resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "任务未找到" }) });
                                }
                            }
                            // --- Servers/Nodes ---
                            else if (url === `${this.apiUrlPrefix}/nodes` && method === 'GET') {
                                resolve({ ok: true, status: 200, json: async () => ({ status: "success", nodes: [...this.mockData.servers] }) });
                            }
                            else if (url.startsWith(`${this.apiUrlPrefix}/nodes/`) && method === 'GET') {
                                const id = url.split('/').pop();
                                const server = this.mockData.servers.find(s => s.node_id === id);
                                if (server) {
                                    const detailServer = {...server};
                                    if (!detailServer.latest_cpu) { 
                                        detailServer.latest_cpu = { core_count: 4, load_avg_1m: Math.random().toFixed(2), load_avg_5m: Math.random().toFixed(2), load_avg_15m: Math.random().toFixed(2), timestamp: Math.floor(Date.now()/1000) - Math.floor(Math.random()*60), usage_percent: (Math.random()*100).toFixed(2) };
                                    }
                                     if (!detailServer.latest_memory) { 
                                        detailServer.latest_memory = { total: 8*1024*1024*1024, used: Math.floor(Math.random()*8*1024*1024*1024), free: 0, usage_percent: 0, timestamp: Math.floor(Date.now()/1000) - Math.floor(Math.random()*60) };
                                        detailServer.latest_memory.free = detailServer.latest_memory.total - detailServer.latest_memory.used;
                                        detailServer.latest_memory.usage_percent = ((detailServer.latest_memory.used / detailServer.latest_memory.total) * 100).toFixed(2);
                                    }
                                    resolve({ ok: true, status: 200, json: async () => ({ status: "success", node: detailServer }) });
                                } else {
                                    resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "服务器节点未找到" }) });
                                }
                            }
                            else {
                                console.warn(`Unhandled mockFetch route: ${method} ${url}`);
                                resolve({ ok: false, status: 404, json: async () => ({ status: "error", message: "接口未找到 (模拟)" }) });
                            }
                        } catch (e) {
                             console.error("Mock fetch processing error:", e, "for", url, options);
                             reject(new Error("Mock fetch JSON parse or processing error: " + e.message));
                        }
                    }, 500); 
                });
            },


            openModal(title, bodyContent, footerButtons = []) {
                document.getElementById('modalTitle').textContent = title;
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = ''; 
                if (typeof bodyContent === 'string') {
                    modalBody.innerHTML = bodyContent;
                } else {
                    modalBody.appendChild(bodyContent);
                }

                const modalFooter = document.getElementById('modalFooter');
                modalFooter.innerHTML = '';
                footerButtons.forEach(btn => {
                    const buttonEl = document.createElement('button');
                    buttonEl.id = `modal_btn_${btn.label.replace(/\s+/g, '_').toLowerCase()}`; 
                    buttonEl.textContent = btn.label;
                    buttonEl.className = `px-4 py-2 rounded-md text-white ${btn.class || 'bg-blue-600 hover:bg-blue-700'}`;
                    buttonEl.onclick = btn.action;
                    modalFooter.appendChild(buttonEl);
                });
                if (footerButtons.length === 0) {
                     const closeButton = document.createElement('button');
                    closeButton.textContent = '关闭';
                    closeButton.className = 'px-4 py-2 rounded-md text-white bg-gray-500 hover:bg-gray-600';
                    closeButton.onclick = () => this.closeModal();
                    modalFooter.appendChild(closeButton);
                }

                document.getElementById('genericModal').classList.add('active');
                if (title.includes("组件模板") && document.getElementById('ct_type')) {
                    this.toggleComponentConfigFields();
                    if (this.editingItemId && this.mockData.componentTemplates.find(t=>t.component_template_id === this.editingItemId)) { 
                        const template = this.mockData.componentTemplates.find(t => t.component_template_id === this.editingItemId);
                         if (template && template.config) { // Check if template and template.config exist
                            this.renderKeyValueRows('affinityContainer', template.config.affinity || {}, '亲和性键', '亲和性值', 'affinity-row', '例如: ip_address', '例如: 192.168.1.10');
                            this.renderKeyValueRows('envVarsContainer', template.config.environment_variables || {}, '环境变量名', '环境变量值', 'env-var-row');
                        } else { // Fallback if template or template.config is missing (should ideally not happen if fetched)
                             this.renderKeyValueRows('affinityContainer', {}, '亲和性键', '亲和性值', 'affinity-row', '例如: ip_address', '例如: 192.168.1.10');
                             this.renderKeyValueRows('envVarsContainer', {}, '环境变量名', '环境变量值', 'env-var-row');
                        }
                    } else { 
                        this.renderKeyValueRows('affinityContainer', {}, '亲和性键', '亲和性值', 'affinity-row', '例如: ip_address', '例如: 192.168.1.10');
                        this.renderKeyValueRows('envVarsContainer', {}, '环境变量名', '环境变量值', 'env-var-row');
                    }
                }
            },

            closeModal() {
                document.getElementById('genericModal').classList.remove('active');
                this.editingItemId = null; 
                if (this.isListModalOpen) {
                    if (this.currentView === 'componentTemplates') {
                        this.openComponentTemplatesListModal();
                    } else if (this.currentView === 'businessTemplates') {
                        this.openBusinessTemplatesListModal();
                    }
                }
            },

            openListModal(title, listContentHTML) {
                document.getElementById('listModalTitle').textContent = title;
                document.getElementById('listModalBody').innerHTML = listContentHTML;
                document.getElementById('listModal').classList.add('active');
                this.isListModalOpen = true;
            },

            closeListModal() {
                document.getElementById('listModal').classList.remove('active');
                this.isListModalOpen = false;
            },

            // --- Navigation ---
            navigateTo(view) {
                const oldView = this.currentView;
                this.currentView = view; 

                if (view === 'componentTemplates') {
                    this.openComponentTemplatesListModal();
                } else if (view === 'businessTemplates') {
                    this.openBusinessTemplatesListModal();
                } else if (view === 'servers') { 
                    if (this.isListModalOpen) this.closeListModal();
                    this.selectedBusinessId = null; 
                    this.renderPageContent(view); 
                }
                else { 
                    if (this.isListModalOpen) this.closeListModal(); 

                    if (view === 'deployedBusinesses') {
                        // Default selection logic is handled within renderPageContent's async IIFE
                    } else {
                        this.selectedBusinessId = null;
                    }
                    this.renderPageContent(view);
                }
            },

            renderPageContent(view) {
                const mainContent = document.getElementById('mainContent');
                mainContent.innerHTML = '<p class="text-center text-green-400 py-10">加载中...</p>'; 
                

                
                (async () => { 
                    let contentHTML = '';
                    try {
                    switch (view) {
                        case 'deployedBusinesses':
                                mainContent.innerHTML = '<p class="text-center text-green-400 py-10">加载已部署业务列表中...</p>';
                                const bizResponse = await fetch(`${this.apiUrlPrefix}/businesses`);
                                const bizJsonData = await bizResponse.json();
                                if (bizResponse.ok && bizJsonData.status === 'success') {
                                    this.mockData.deployedBusinesses = bizJsonData.businesses || [];
                                    if (this.mockData.deployedBusinesses.length > 0 && this.selectedBusinessId === null) { 
                                        this.selectedBusinessId = this.mockData.deployedBusinesses[0].business_id;
                                    } else if (this.mockData.deployedBusinesses.length > 0 && !this.mockData.deployedBusinesses.find(b => b.business_id === this.selectedBusinessId)) {
                                        this.selectedBusinessId = this.mockData.deployedBusinesses[0].business_id;
                                    } else if (this.mockData.deployedBusinesses.length === 0) { 
                                        this.selectedBusinessId = null;
                                    }
                                    contentHTML = await this.getDeployedBusinessesPageHTML();
                                } else {
                                    this.showNotification(bizJsonData.message || '获取已部署业务列表失败', 'error');
                                    contentHTML = '<p class="text-center text-red-400 py-10">加载已部署业务列表失败。</p>';
                                }
                            break;
                            case 'servers':
                                mainContent.innerHTML = '<p class="text-center text-green-400 py-10">加载服务器列表中...</p>';
                                const serverResponse = await fetch(`${this.apiUrlPrefix}/nodes`);
                                const serverJsonData = await serverResponse.json();
                                if (serverResponse.ok && serverJsonData.status === 'success') {
                                    this.mockData.servers = serverJsonData.nodes || [];
                                    contentHTML = this.getServersPageHTML();
                                } else {
                                    this.showNotification(serverJsonData.message || '获取服务器列表失败', 'error');
                                    contentHTML = '<p class="text-center text-red-400 py-10">加载服务器列表失败。</p>';
                                }
                            break;
                        default:
                            if (view === 'componentTemplates' || view === 'businessTemplates') {
                                 console.warn(`Attempted to render modal view '${view}' as page. Defaulting to deployedBusinesses.`);
                                 this.currentView = 'deployedBusinesses'; 
                                     this.navigateTo('deployedBusinesses'); 
                                     return; 
                            } else {
                                contentHTML = `<p class="text-center text-red-500">视图 '${view}' 未找到.</p>`;
                            }
                    }
                    mainContent.innerHTML = contentHTML;
                    } catch (error) {
                        console.error("Failed to render page:", error);
                        this.showNotification('页面渲染失败: ' + error.message, 'error');
                        mainContent.innerHTML = '<p class="text-center text-red-400 py-10">页面加载失败。</p>';
                    }
                })();
            },
            
            // --- Component Template Management (List Modal and Forms) ---
            async openComponentTemplatesListModal() {
                const listModalBody = document.getElementById('listModalBody');
                if (listModalBody) listModalBody.innerHTML = '<p class="text-center text-gray-500 py-10">加载应用模板列表中...</p>';
                this.openListModal('应用模板管理', listModalBody.innerHTML); 

                try {
                    const response = await fetch(`${this.apiUrlPrefix}/templates/components`);
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success') {
                        this.mockData.componentTemplates = jsonData.templates || [];
                const listHTML = this.getComponentTemplatesListHTML();
                        document.getElementById('listModalBody').innerHTML = listHTML; 
                    } else {
                                            this.showNotification(jsonData.message || '获取应用模板列表失败', 'error');
                    document.getElementById('listModalBody').innerHTML = '<p class="text-center text-red-500 py-10">加载失败。</p>';
                    }
                } catch (error) {
                    console.error("Failed to fetch component templates:", error);
                    this.showNotification('获取应用模板列表请求失败: ' + error.message, 'error');
                     document.getElementById('listModalBody').innerHTML = '<p class="text-center text-red-500 py-10">加载失败。</p>';
                }
            },

            getComponentTemplatesListHTML() {
                let content = `<div class="flex justify-end mb-4">
                                <button onclick="app.showCreateComponentTemplateForm()" class="bg-green-600 hover:bg-green-700 text-black px-4 py-2 rounded-md shadow hover:shadow-lg transition duration-150 ease-in-out border border-green-400"><i class="fas fa-plus mr-2"></i>创建新模板</button>
                               </div>
                               <div class="table-responsive max-h-[65vh] overflow-y-auto">
                               <table class="min-w-full divide-y divide-green-500">
                                <thead class="bg-black sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">组件文件</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-black divide-y divide-green-500">`;
                
                if (this.mockData.componentTemplates.length === 0) {
                    content += `<tr><td colspan="5" class="text-center text-green-400 py-10">暂无应用模板。</td></tr>`;
                } else {
                this.mockData.componentTemplates.forEach(template => {
                    let mainFile = 'N/A';
                    if (template.type === 'docker' && template.config && template.config.image_name) {
                        mainFile = template.config.image_name;
                    } else if (template.type === 'binary' && template.config && template.config.binary_path) {
                        mainFile = template.config.binary_path;
                    }

                    content += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-400">${template.template_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-300">${template.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-300 truncate max-w-md" title="${mainFile}">${mainFile}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-300 truncate max-w-xs" title="${template.description}">${template.description || '无'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button onclick="app.showComponentTemplateDetails('${template.component_template_id}')" class="text-green-500 hover:text-green-300" title="查看详情">查看</button>
                                <button onclick="app.showEditComponentTemplateForm('${template.component_template_id}')" class="text-yellow-500 hover:text-yellow-300" title="编辑">编辑</button>
                                <button onclick="app.deleteComponentTemplate('${template.component_template_id}')" class="text-red-500 hover:text-red-300" title="删除">删除</button>
                            </td>
                        </tr>`;
                });
                }
                content += `</tbody></table></div>`;
                return content;
            },
            
            addKeyValueRow(containerId, key = '', value = '', keyPlaceholder = '键', valuePlaceholder = '值', rowClass = 'kv-row') {
                const container = document.getElementById(containerId);
                if (!container) return;

                const rowDiv = document.createElement('div');
                rowDiv.className = `key-value-row ${rowClass}`;

                const keyInput = document.createElement('input');
                keyInput.type = 'text';
                keyInput.dataset.type = 'key'; 
                keyInput.placeholder = keyPlaceholder;
                keyInput.value = key;
                keyInput.className = 'block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm';
                
                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.dataset.type = 'value'; 
                valueInput.placeholder = valuePlaceholder;
                valueInput.value = value;
                valueInput.className = 'block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm';

                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteButton.className = 'text-red-500 hover:text-red-700 px-2 py-1 rounded-md flex-shrink-0';
                deleteButton.onclick = () => rowDiv.remove();

                rowDiv.appendChild(keyInput);
                rowDiv.appendChild(valueInput);
                rowDiv.appendChild(deleteButton);
                container.appendChild(rowDiv);
            },

            renderKeyValueRows(containerId, dataObject, keyPlaceholder, valuePlaceholder, rowClass, keyPlaceholderForEmpty = keyPlaceholder, valuePlaceholderForEmpty = valuePlaceholder) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = ''; 
                if (dataObject && typeof dataObject === 'object' && Object.keys(dataObject).length > 0) {
                    for (const [key, value] of Object.entries(dataObject)) {
                        this.addKeyValueRow(containerId, key, String(value), keyPlaceholder, valuePlaceholder, rowClass);
                    }
                } else { 
                     this.addKeyValueRow(containerId, '', '', keyPlaceholderForEmpty, valuePlaceholderForEmpty, rowClass);
                }
            },


            getComponentTemplateFormHTML(template = {}) { 
                const isCreate = !template.component_template_id;
                const typeDefault = isCreate ? 'binary' : template.type; 

                return `
                    <form id="componentTemplateForm" class="space-y-4">
                        <div><label for="ct_template_name" class="block text-sm font-medium text-green-400">模板名称</label><input type="text" id="ct_template_name" name="template_name" value="${template.template_name || ''}" required class="mt-1 block w-full px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400"></div>
                        <div><label for="ct_type" class="block text-sm font-medium text-green-400">类型</label>
                            <select id="ct_type" name="type" onchange="app.toggleComponentConfigFields()" class="mt-1 block w-full px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400">
                                <option value="binary" ${typeDefault === 'binary' ? 'selected' : ''}>Binary</option>
                                <option value="docker" ${typeDefault === 'docker' ? 'selected' : ''}>Docker</option>
                            </select>
                        </div>
                        <div><label for="ct_description" class="block text-sm font-medium text-green-400">描述</label><textarea id="ct_description" name="description" rows="2" class="mt-1 block w-full px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400">${template.description || ''}</textarea></div>
                        
                        <div id="dockerFields" class="space-y-4 config-type-fields">
                            <div><label for="ct_image_url" class="block text-sm font-medium text-green-400">镜像URL</label><input type="text" id="ct_image_url" name="image_url" value="${template.config && template.type === 'docker' ? (template.config.image_url || '') : ''}" class="mt-1 block w-full px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400"></div>
                            <div><label for="ct_image_name" class="block text-sm font-medium text-green-400">镜像名</label><input type="text" id="ct_image_name" name="image_name" value="${template.config && template.type === 'docker' ? (template.config.image_name || '') : ''}" class="mt-1 block w-full px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400"></div>
                        </div>
                        <div id="binaryFields" class="space-y-4 config-type-fields">
                            <div><label for="ct_binary_path" class="block text-sm font-medium text-green-400">二进制路径</label><input type="text" id="ct_binary_path" name="binary_path" value="${template.config && template.type === 'binary' ? (template.config.binary_path || '') : ''}" class="mt-1 block w-full px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400"></div>
                            <div><label for="ct_binary_url" class="block text-sm font-medium text-green-400">二进制下载链接</label><input type="text" id="ct_binary_url" name="binary_url" value="${template.config && template.type === 'binary' ? (template.config.binary_url || '') : ''}" class="mt-1 block w-full px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400"></div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-green-400">亲和性配置</label>
                            <div id="affinityContainer" class="mt-1 space-y-2 p-2 border border-green-500 rounded-md bg-black max-h-40 overflow-y-auto">
                            </div>
                            <button type="button" onclick="app.addKeyValueRow('affinityContainer', '', '', '例如: ip_address', '例如: 192.168.1.10', 'affinity-row')" class="mt-2 text-sm text-green-500 hover:text-green-300"><i class="fas fa-plus mr-1"></i>添加亲和性规则</button>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-green-400">环境变量</label>
                            <div id="envVarsContainer" class="mt-1 space-y-2 p-2 border border-green-500 rounded-md bg-black max-h-40 overflow-y-auto">
                            </div>
                            <button type="button" onclick="app.addKeyValueRow('envVarsContainer', '', '', '环境变量名', '环境变量值', 'env-var-row')" class="mt-2 text-sm text-green-500 hover:text-green-300"><i class="fas fa-plus mr-1"></i>添加环境变量</button>
                        </div>
                    </form>
                `;
            },
            toggleComponentConfigFields() { 
                const typeSelect = document.getElementById('ct_type');
                const dockerFields = document.getElementById('dockerFields');
                const binaryFields = document.getElementById('binaryFields');
                if (!typeSelect || !dockerFields || !binaryFields) return;
                const selectedType = typeSelect.value;
                if (selectedType === 'docker') { dockerFields.style.display = 'block'; binaryFields.style.display = 'none';}
                else if (selectedType === 'binary') { dockerFields.style.display = 'none'; binaryFields.style.display = 'block';}
                else { dockerFields.style.display = 'none'; binaryFields.style.display = 'none';}
            },
            showCreateComponentTemplateForm() { 
                this.editingItemId = null; 
                const formHTML = this.getComponentTemplateFormHTML();
                const footerButtons = [ { label: '保存', id:"saveCtBtn", action: () => this.saveComponentTemplate(), class: 'bg-green-600 hover:bg-green-700 text-black border border-green-400' }, { label: '取消', action: () => this.closeModal(), class: 'bg-gray-600 hover:bg-gray-700 text-green-400 border border-gray-500' }];
                this.openModal('创建应用模板', formHTML, footerButtons);
            },
            async showEditComponentTemplateForm(id) { 
                this.editingItemId = id;
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/templates/components/${id}`);
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success' && jsonData.template) {
                        const formHTML = this.getComponentTemplateFormHTML(jsonData.template); 
                        const footerButtons = [ { label: '更新', id:"updateCtBtn", action: () => this.saveComponentTemplate(), class: 'bg-green-600 hover:bg-green-700 text-black border border-green-400' }, { label: '取消', action: () => this.closeModal(), class: 'bg-gray-600 hover:bg-gray-700 text-green-400 border border-gray-500' }];
                this.openModal('编辑应用模板', formHTML, footerButtons);
                    } else {
                        this.showNotification(jsonData.message || '获取模板详情失败', 'error');
                        this.editingItemId = null; 
                    }
                } catch (error) {
                    console.error("Failed to fetch template details for edit:", error);
                    this.showNotification('获取模板详情请求失败: ' + error.message, 'error');
                    this.editingItemId = null; 
                }
            },
            async saveComponentTemplate() {
                const saveButton = document.getElementById(this.editingItemId ? 'modal_btn_更新' : 'modal_btn_保存');
                if (saveButton) {
                    saveButton.classList.add('button-loading');
                    saveButton.disabled = true;
                }

                const form = document.getElementById('componentTemplateForm');
                const formData = new FormData(form);
                const type = formData.get('type');

                const envVars = {};
                document.querySelectorAll('#envVarsContainer .env-var-row').forEach(row => {
                    const keyInput = row.querySelector('input[data-type="key"]');
                    const valueInput = row.querySelector('input[data-type="value"]');
                    if (keyInput && valueInput && keyInput.value.trim() !== '') {
                        envVars[keyInput.value.trim()] = valueInput.value.trim();
                    }
                });

                const affinity = {};
                let affinityHasEntries = false;
                document.querySelectorAll('#affinityContainer .affinity-row').forEach(row => {
                    const keyInput = row.querySelector('input[data-type="key"]');
                    const valueInput = row.querySelector('input[data-type="value"]');
                    if (keyInput && valueInput && keyInput.value.trim() !== '') {
                        affinity[keyInput.value.trim()] = valueInput.value.trim();
                        affinityHasEntries = true;
                    }
                });

                let config = {};
                if (Object.keys(envVars).length > 0) {
                    config.environment_variables = envVars;
                }
                if (affinityHasEntries) {
                    config.affinity = affinity;
                }
                
                if (type === 'docker') { 
                    config.image_url = formData.get('image_url'); 
                    config.image_name = formData.get('image_name'); 
                } else if (type === 'binary') { 
                    config.binary_path = formData.get('binary_path'); 
                    config.binary_url = formData.get('binary_url');
                }
                
                const templateName = formData.get('template_name');
                if (!templateName.trim()) {
                    this.showNotification('模板名称不能为空。', 'error');
                    if (saveButton) {
                        saveButton.classList.remove('button-loading');
                        saveButton.disabled = false;
                    }
                    return;
                }

                const templateDataForApi = { 
                    template_name: templateName, 
                    type: type, 
                    description: formData.get('description'), 
                    config: config
                };

                let url, method;
                if (this.editingItemId) { 
                    url = `${this.apiUrlPrefix}/templates/components/${this.editingItemId}`;
                    method = 'PUT';
                } else { 
                    url = `${this.apiUrlPrefix}/templates/components`;
                    method = 'POST';
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(templateDataForApi)
                    });
                    const jsonData = await response.json();

                    if (response.ok && jsonData.status === 'success') {
                        this.showNotification(jsonData.message || (method === 'POST' ? '应用模板已创建' : '应用模板已更新'), 'success');
                this.closeModal(); 
                    } else {
                        this.showNotification(jsonData.message || '操作失败', 'error');
                    }
                } catch (error) {
                    console.error("API call failed:", error);
                    this.showNotification('操作请求失败: ' + error.message, 'error');
                } finally {
                    if (saveButton) {
                        saveButton.classList.remove('button-loading');
                        saveButton.disabled = false;
                    }
                }
            },
            async showComponentTemplateDetails(id) { 
                const modalBody = document.getElementById('modalBody');
                this.openModal(`应用模板详情: 加载中...`, '<p class="text-center text-gray-500 py-5">加载详情...</p>');
                
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/templates/components/${id}`);
                    const jsonData = await response.json();

                    if (response.ok && jsonData.status === 'success' && jsonData.template) {
                        const template = jsonData.template;
                        let detailsHTML = `<div class="space-y-3">
                            <p><strong>ID:</strong> ${template.component_template_id}</p>
                            <p><strong>名称:</strong> ${template.template_name}</p>
                            <p><strong>类型:</strong> ${template.type}</p>
                            <p><strong>描述:</strong> ${template.description || '无'}</p>
                            <p><strong>配置:</strong></p>
                            <pre class="bg-gray-100 p-3 rounded-md text-sm overflow-x-auto">${JSON.stringify(template.config, null, 2)}</pre>
                            <p><strong>创建时间:</strong> ${new Date(template.created_at).toLocaleString('zh-CN')}</p>
                            <p><strong>更新时间:</strong> ${new Date(template.updated_at).toLocaleString('zh-CN')}</p>
                        </div>`;
                        document.getElementById('modalTitle').textContent = `应用模板详情: ${template.template_name}`;
                        modalBody.innerHTML = detailsHTML;
                    } else {
                        this.showNotification(jsonData.message || '获取模板详情失败', 'error');
                        modalBody.innerHTML = '<p class="text-center text-red-500 py-5">加载详情失败。</p>';
                    }
                } catch (error) {
                    console.error("Failed to fetch template details:", error);
                    this.showNotification('获取模板详情请求失败: ' + error.message, 'error');
                    modalBody.innerHTML = '<p class="text-center text-red-500 py-5">加载详情失败。</p>';
                }
            },
            deleteComponentTemplate(id) { 
                const template = this.mockData.componentTemplates.find(t => t.component_template_id === id);
                this.openModal( '确认删除', `<p>确定要删除应用模板 <strong>${template ? template.template_name : id}</strong> 吗？</p><p class="text-sm text-red-600 mt-2">此操作无法撤销。</p>`, 
                [ 
                    { label: '确认删除', action: () => this._confirmDeleteComponentTemplate(id), class: 'bg-red-600 hover:bg-red-700 text-black border border-red-400' }, 
                    { label: '取消', action: () => this.closeModal(), class: 'bg-gray-600 hover:bg-gray-700 text-green-400 border border-gray-500' }
                ]);
            },
            async _confirmDeleteComponentTemplate(id) { 
                const deleteButtonInConfirmModal = document.getElementById('modal_btn_确认删除');
                if(deleteButtonInConfirmModal) {
                    deleteButtonInConfirmModal.classList.add('button-loading');
                    deleteButtonInConfirmModal.disabled = true;
                }

                 const isInUse = this.mockData.businessTemplates.some(bt => bt.components.some(c => c.component_template_id === id));
                if (isInUse) { 
                    this.showNotification(`应用模板 ${id} 正在被一个或多个任务模板使用，无法删除。`, 'error'); 
                    if(deleteButtonInConfirmModal) {
                        deleteButtonInConfirmModal.classList.remove('button-loading');
                        deleteButtonInConfirmModal.disabled = false;
                    }
                    return; 
                }
                
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/templates/components/${id}`, { method: 'DELETE' });
                    const jsonData = await response.json();

                    if (response.ok && jsonData.status === 'success') {
                        this.showNotification(jsonData.message || '应用模板已删除', 'success');
                this.closeModal(); 
                    } else {
                        this.showNotification(jsonData.message || '删除失败', 'error');
                         if(deleteButtonInConfirmModal) {
                            deleteButtonInConfirmModal.classList.remove('button-loading');
                            deleteButtonInConfirmModal.disabled = false;
                        }
                    }
                } catch (error) {
                    console.error("Delete API call failed:", error);
                    this.showNotification('删除请求失败: ' + error.message, 'error');
                     if(deleteButtonInConfirmModal) {
                        deleteButtonInConfirmModal.classList.remove('button-loading');
                        deleteButtonInConfirmModal.disabled = false;
                    }
                }
            },

            // --- Business Template Management (List Modal and Forms) ---
            async openBusinessTemplatesListModal() {
                const listModalBody = document.getElementById('listModalBody');
                if (listModalBody) listModalBody.innerHTML = '<p class="text-center text-gray-500 py-10">加载任务模板列表中...</p>';
                this.openListModal('任务模板管理', listModalBody.innerHTML);

                try {
                    const response = await fetch(`${this.apiUrlPrefix}/templates/businesses`);
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success') {
                        this.mockData.businessTemplates = jsonData.templates || [];
                        if (this.mockData.componentTemplates.length === 0) { 
                            await this.fetchComponentTemplatesForBusinessForms();
                        }
                const listHTML = this.getBusinessTemplatesListHTML();
                        document.getElementById('listModalBody').innerHTML = listHTML;
                    } else {
                                            this.showNotification(jsonData.message || '获取任务模板列表失败', 'error');
                    document.getElementById('listModalBody').innerHTML = '<p class="text-center text-red-500 py-10">加载失败。</p>';
                    }
                } catch (error) {
                    console.error("Failed to fetch business templates:", error);
                    this.showNotification('获取任务模板列表请求失败: ' + error.message, 'error');
                    document.getElementById('listModalBody').innerHTML = '<p class="text-center text-red-500 py-10">加载失败。</p>';
                }
            },
            
            async fetchComponentTemplatesForBusinessForms() {
                if (this.mockData.componentTemplates.length > 0 && this.mockData.componentTemplates.find(ct => ct.component_template_id.startsWith("ct-init-"))) { 
                } else if (this.mockData.componentTemplates.length > 0) {
                    return; 
                }
                
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/templates/components`);
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success') {
                        this.mockData.componentTemplates = jsonData.templates || [];
                    } else {
                         console.warn("Could not pre-fetch component templates for business forms.");
                    }
                } catch (error) {
                     console.warn("Error pre-fetching component templates:", error);
                }
            },


            getBusinessTemplatesListHTML() {
                let content = `<div class="flex justify-end mb-4">
                                <button onclick="app.showCreateBusinessTemplateForm()" class="bg-green-600 hover:bg-green-700 text-black px-4 py-2 rounded-md shadow hover:shadow-lg transition duration-150 ease-in-out border border-green-400"><i class="fas fa-plus mr-2"></i>创建新模板</button>
                               </div>
                               <div class="table-responsive max-h-[65vh] overflow-y-auto">
                                                               <table class="min-w-full divide-y divide-green-500">
                                <thead class="bg-black sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">名称</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">描述</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">组件数</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">更新时间</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-400 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-black divide-y divide-green-500">`;
                
                if(this.mockData.businessTemplates.length === 0) {
                    content += `<tr><td colspan="5" class="text-center text-green-400 py-10">暂无业务模板。</td></tr>`;
                } else {
                this.mockData.businessTemplates.forEach(template => {
                    content += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-400">${template.template_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-300 truncate max-w-xs" title="${template.description}">${template.description}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-300">${template.components ? template.components.length : 0}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-300">${new Date(template.updated_at).toLocaleString('zh-CN')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button onclick="app.showBusinessTemplateDetails('${template.business_template_id}')" class="text-green-500 hover:text-green-300" title="查看详情">查看</button>
                                <button onclick="app.showEditBusinessTemplateForm('${template.business_template_id}')" class="text-yellow-500 hover:text-yellow-300" title="编辑">编辑</button>
                                <button onclick="app.deleteBusinessTemplate('${template.business_template_id}')" class="text-red-500 hover:text-red-300" title="删除">删除</button>
                                <button onclick="app.showDeployBusinessForm('${template.business_template_id}')" class="text-green-500 hover:text-green-300" title="部署">部署</button>
                            </td>
                        </tr>`;
                });
                }
                content += `</tbody></table></div>`;
                return content;
            },
            getBusinessTemplateFormHTML(template = {}) { 
                let componentOptions = this.mockData.componentTemplates.map(ct => `<option value="${ct.component_template_id}">${ct.template_name} (${ct.component_template_id})</option>`).join('');
                let selectedComponentsHTML = '';
                if (template.components && template.components.length > 0) {
                    selectedComponentsHTML = template.components.map(c => { const compTpl = this.mockData.componentTemplates.find(ct => ct.component_template_id === c.component_template_id); return `<li data-id="${c.component_template_id}" class="flex justify-between items-center p-2 bg-gray-100 rounded-md mb-1"><span>${compTpl ? compTpl.template_name : c.component_template_id}</span><button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">&times;</button></li>`; }).join('');
                }
                return `
                    <form id="businessTemplateForm" class="space-y-4">
                        <div><label for="bt_template_name" class="block text-sm font-medium text-green-400">模板名称</label><input type="text" id="bt_template_name" name="template_name" value="${template.template_name || ''}" required class="mt-1 block w-full px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400"></div>
                        <div><label for="bt_description" class="block text-sm font-medium text-green-400">描述</label><textarea id="bt_description" name="description" rows="3" class="mt-1 block w-full px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400">${template.description || ''}</textarea></div>
                        <div><label for="bt_component_select" class="block text-sm font-medium text-green-400">选择应用模板</label><div class="flex space-x-2 mt-1"><select id="bt_component_select" class="flex-grow px-3 py-2 border border-green-500 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-black text-green-400"><option value="">-- 请选择 --</option>${componentOptions}</select><button type="button" onclick="app.addSelectedComponentToBusinessTemplateForm()" class="bg-green-600 hover:bg-green-700 text-black px-3 py-2 rounded-md text-sm border border-green-400">添加</button></div></div>
                        <div><label class="block text-sm font-medium text-green-400">已选应用</label><ul id="bt_selected_components" class="mt-1 border border-green-500 rounded-md p-2 h-32 overflow-y-auto bg-black">${selectedComponentsHTML}</ul></div>
                    </form>
                `;
            },
            addSelectedComponentToBusinessTemplateForm() { 
                const selectEl = document.getElementById('bt_component_select'); const selectedId = selectEl.value; if (!selectedId) return;
                const componentTemplate = this.mockData.componentTemplates.find(ct => ct.component_template_id === selectedId); if (!componentTemplate) return;
                const existingLi = document.querySelector(`#bt_selected_components li[data-id="${selectedId}"]`); if (existingLi) { this.showNotification('该应用模板已添加', 'error'); return; }
                const listEl = document.getElementById('bt_selected_components'); const listItem = document.createElement('li'); listItem.dataset.id = selectedId; listItem.className = "flex justify-between items-center p-2 bg-gray-100 rounded-md mb-1"; listItem.innerHTML = `<span>${componentTemplate.template_name} (${selectedId})</span><button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">&times;</button>`; listEl.appendChild(listItem); selectEl.value = '';
            },
            async showCreateBusinessTemplateForm() { 
                await this.fetchComponentTemplatesForBusinessForms(); 
                if (this.mockData.componentTemplates.length === 0) { this.showNotification('请先创建应用模板，或等待应用模板加载完成。', 'error'); return; }
                const formHTML = this.getBusinessTemplateFormHTML();
                const footerButtons = [ { label: '保存', action: () => this.saveBusinessTemplate(), class: 'bg-green-600 hover:bg-green-700 text-black border border-green-400' }, { label: '取消', action: () => this.closeModal(), class: 'bg-gray-600 hover:bg-gray-700 text-green-400 border border-gray-500' }];
                this.openModal('创建业务模板', formHTML, footerButtons);
            },
            async showEditBusinessTemplateForm(id) { 
                this.editingItemId = id;
                await this.fetchComponentTemplatesForBusinessForms(); 
                if (this.mockData.componentTemplates.length === 0) { this.showNotification('应用模板加载中，请稍后再试。', 'error');}
                
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/templates/businesses/${id}`);
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success' && jsonData.template) {
                        const formHTML = this.getBusinessTemplateFormHTML(jsonData.template);
                        const footerButtons = [ { label: '更新', action: () => this.saveBusinessTemplate(), class: 'bg-green-600 hover:bg-green-700 text-black border border-green-400' }, { label: '取消', action: () => this.closeModal(), class: 'bg-gray-600 hover:bg-gray-700 text-green-400 border border-gray-500' }];
                this.openModal('编辑业务模板', formHTML, footerButtons);
                    } else {
                        this.showNotification(jsonData.message || '获取业务模板详情失败', 'error');
                        this.editingItemId = null;
                    }
                } catch (error) {
                     console.error("Failed to fetch business template details for edit:", error);
                    this.showNotification('获取业务模板详情请求失败: ' + error.message, 'error');
                    this.editingItemId = null;
                }
            },
            async saveBusinessTemplate() { 
                const saveButton = document.getElementById(this.editingItemId ? 'modal_btn_更新' : 'modal_btn_保存');
                 if (saveButton) {
                    saveButton.classList.add('button-loading');
                    saveButton.disabled = true;
                }

                const form = document.getElementById('businessTemplateForm'); const formData = new FormData(form);
                const selectedComponents = []; 
                document.querySelectorAll('#bt_selected_components li').forEach(li => { 
                    selectedComponents.push({ component_template_id: li.dataset.id }); 
                });
                if (selectedComponents.length === 0) { 
                    this.showNotification('请至少选择一个应用模板', 'error'); 
                    if (saveButton) { saveButton.classList.remove('button-loading'); saveButton.disabled = false; }
                    return; 
                }
                const templateName = formData.get('template_name'); 
                if (!templateName.trim()) { 
                    this.showNotification('模板名称不能为空。', 'error'); 
                    if (saveButton) { saveButton.classList.remove('button-loading'); saveButton.disabled = false; }
                    return; 
                }
                
                const templateDataForApi = { 
                    template_name: templateName, 
                    description: formData.get('description'), 
                    components: selectedComponents
                };

                let url, method;
                if (this.editingItemId) { 
                    url = `${this.apiUrlPrefix}/templates/businesses/${this.editingItemId}`;
                    method = 'PUT';
                } else { 
                    url = `${this.apiUrlPrefix}/templates/businesses`;
                    method = 'POST';
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json'},
                        body: JSON.stringify(templateDataForApi)
                    });
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success') {
                        this.showNotification(jsonData.message || (method === 'POST' ? '业务模板已创建' : '业务模板已更新'), 'success');
                this.closeModal(); 
                    } else {
                        this.showNotification(jsonData.message || '操作失败', 'error');
                    }
                } catch (error) {
                    console.error("Business Template API call failed:", error);
                    this.showNotification('业务模板操作请求失败: ' + error.message, 'error');
                } finally {
                    if (saveButton) { saveButton.classList.remove('button-loading'); saveButton.disabled = false; }
                }
            },
            async showBusinessTemplateDetails(id) { 
                const modalBody = document.getElementById('modalBody');
                this.openModal(`业务模板详情: 加载中...`, '<p class="text-center text-gray-500 py-5">加载详情...</p>');
                
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/templates/businesses/${id}`);
                    const jsonData = await response.json();

                    if (response.ok && jsonData.status === 'success' && jsonData.template) {
                        const template = jsonData.template;
                        let componentsDetails = '无组件';
                        if (template.components && template.components.length > 0) {
                            componentsDetails = template.components.map(c => {
                                const name = c.template_details ? c.template_details.template_name : c.component_template_id;
                                return `<li>${name} (ID: ${c.component_template_id})</li>`;
                            }).join('');
                        }

                        let detailsHTML = `<div class="space-y-3">
                            <p><strong>ID:</strong> ${template.business_template_id}</p>
                            <p><strong>名称:</strong> ${template.template_name}</p>
                            <p><strong>描述:</strong> ${template.description || '无'}</p>
                            <p><strong>应用模板:</strong></p>
                            <ul class="list-disc list-inside ml-4 bg-gray-50 p-2 rounded">${componentsDetails}</ul>
                            <p><strong>创建时间:</strong> ${new Date(template.created_at).toLocaleString('zh-CN')}</p>
                            <p><strong>更新时间:</strong> ${new Date(template.updated_at).toLocaleString('zh-CN')}</p>
                        </div>`;
                        document.getElementById('modalTitle').textContent = `业务模板详情: ${template.template_name}`;
                        modalBody.innerHTML = detailsHTML;

                    } else {
                         this.showNotification(jsonData.message || '获取业务模板详情失败', 'error');
                        modalBody.innerHTML = '<p class="text-center text-red-500 py-5">加载详情失败。</p>';
                    }
                } catch (error) {
                    console.error("Failed to fetch business template details:", error);
                    this.showNotification('获取业务模板详情请求失败: ' + error.message, 'error');
                    modalBody.innerHTML = '<p class="text-center text-red-500 py-5">加载详情失败。</p>';
                }
            },
            deleteBusinessTemplate(id) { 
                const template = this.mockData.businessTemplates.find(t => t.business_template_id === id);
                this.openModal( '确认删除', `<p>确定要删除业务模板 <strong>${template ? template.template_name : id}</strong> 吗？</p><p class="text-sm text-red-600 mt-2">此操作无法撤销。</p>`, 
                [ 
                    { label: '确认删除', action: () => this._confirmDeleteBusinessTemplate(id), class: 'bg-red-600 hover:bg-red-700 text-white' }, 
                    { label: '取消', action: () => this.closeModal(), class: 'bg-gray-300 hover:bg-gray-400 text-gray-800' }
                ]);
            },
            async _confirmDeleteBusinessTemplate(id) { 
                const deleteButtonInConfirmModal = document.getElementById('modal_btn_确认删除');
                if(deleteButtonInConfirmModal) {
                    deleteButtonInConfirmModal.classList.add('button-loading');
                    deleteButtonInConfirmModal.disabled = true;
                }
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/templates/businesses/${id}`, { method: 'DELETE' }); 
                    const jsonData = await response.json();

                    if (response.ok && jsonData.status === 'success') {
                        this.showNotification(jsonData.message || '业务模板已删除', 'success');
                this.closeModal(); 
                    } else {
                        this.showNotification(jsonData.message || '删除失败', 'error');
                         if(deleteButtonInConfirmModal) {
                            deleteButtonInConfirmModal.classList.remove('button-loading');
                            deleteButtonInConfirmModal.disabled = false;
                        }
                    }
                } catch (error) {
                    console.error("Delete Business Template API call failed:", error);
                    this.showNotification('删除业务模板请求失败: ' + error.message, 'error');
                     if(deleteButtonInConfirmModal) {
                        deleteButtonInConfirmModal.classList.remove('button-loading');
                        deleteButtonInConfirmModal.disabled = false;
                    }
                }
            },

            // --- Deployment ---
            async showDeployBusinessForm(templateId) { 
                const modalBody = document.getElementById('modalBody');
                this.openModal('部署业务', '<p class="text-center text-gray-500 py-5">准备部署信息...</p>');

                try {
                    const templateResponse = await fetch(`${this.apiUrlPrefix}/templates/businesses/${templateId}`);
                    const templateJsonData = await templateResponse.json();

                    if (!templateResponse.ok || templateJsonData.status !== 'success' || !templateJsonData.template) {
                        this.showNotification(templateJsonData.message || '获取业务模板信息失败', 'error');
                        this.closeModal();
                        return;
                    }
                    const businessTemplate = templateJsonData.template;
                this.editingItemId = templateId; 

                    const formHTML = `
                        <form id="deployBusinessForm" class="space-y-4">
                            <p>从业务模板部署: <strong>${businessTemplate.template_name}</strong> (ID: ${templateId})</p>
                            <p class="text-sm text-gray-600">点击"部署"将使用模板 <strong>${templateId}</strong> 创建新的业务实例。</p>
                            <input type="hidden" name="business_template_id" value="${templateId}">
                        </form>`;
                    
                    const footerButtons = [ 
                        { label: '部署', action: () => this.deployBusinessFromTemplate(), class: 'bg-green-600 hover:bg-green-700 text-white' }, 
                        { label: '取消', action: () => this.closeModal(), class: 'bg-gray-300 hover:bg-gray-400 text-gray-800' }
                    ];
                    
                this.openModal('部署业务', formHTML, footerButtons); 

                } catch (error) {
                    console.error("Error preparing deployment form:", error);
                    this.showNotification("准备部署表单失败: " + error.message, 'error');
                    this.closeModal();
                }
            },
            async deployBusinessFromTemplate() { 
                const deployButton = document.getElementById('modal_btn_部署');
                if(deployButton) {
                    deployButton.classList.add('button-loading');
                    deployButton.disabled = true;
                }

                const templateId = this.editingItemId; 
                if (!templateId) {
                    this.showNotification('未指定业务模板ID。', 'error');
                    if(deployButton) { deployButton.classList.remove('button-loading'); deployButton.disabled = false; }
                    return;
                }
                
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/businesses/template/${templateId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    const jsonData = await response.json();

                    if (response.ok && jsonData.status === 'success' && jsonData.business_id) {
                        this.showNotification(jsonData.message || '业务已成功从模板部署', 'success');
                        
                        if (this.isListModalOpen) this.closeListModal();
                        this.currentView = 'deployedBusinesses'; 
                        this.selectedBusinessId = jsonData.business_id; 
                        this.renderPageContent('deployedBusinesses'); 
                this.closeModal(); 

                    } else {
                        this.showNotification(jsonData.message || '从模板部署业务失败', 'error');
                    }
                } catch (error) {
                    console.error("Deploy from template API call failed:", error);
                    this.showNotification('从模板部署业务请求失败: ' + error.message, 'error');
                } finally {
                     if(deployButton) { deployButton.classList.remove('button-loading'); deployButton.disabled = false; }
                }
            },

            // --- Deployed Business Monitoring (Page View) ---
            async getDeployedBusinessesPageHTML() { 
                // 获取服务器数据
                let serversHTML = '';
                try {
                    const serverResponse = await fetch(`${this.apiUrlPrefix}/nodes`);
                    const serverJsonData = await serverResponse.json();
                    if (serverResponse.ok && serverJsonData.status === 'success') {
                        this.mockData.servers = serverJsonData.nodes || [];
                        serversHTML = this.getServersSidebarHTML();
                    }
                } catch (error) {
                    console.error("Failed to fetch servers for sidebar:", error);
                }

                let listHTML = `<div class="w-1/4 pr-2 border-r border-green-500 overflow-y-auto h-full"> 
                    <div class="flex justify-between items-center mb-3 sticky top-0 bg-black py-2 z-10 px-2">
                        <h3 class="text-lg font-semibold text-green-500">任务列表</h3>
                        <div class="flex space-x-1">
                            <button onclick="app.navigateTo('componentTemplates')" class="bg-green-600 hover:bg-green-700 text-black px-2 py-1 rounded text-xs shadow hover:shadow-md transition border border-green-400" title="应用模板">
                                <i class="fas fa-cube mr-1"></i>应用
                            </button>
                            <button onclick="app.navigateTo('businessTemplates')" class="bg-green-600 hover:bg-green-700 text-black px-2 py-1 rounded text-xs shadow hover:shadow-md transition border border-green-400" title="任务模板">
                                <i class="fas fa-layer-group mr-1"></i>任务
                            </button>
                        </div>
                    </div>`;
                if (this.mockData.deployedBusinesses.length === 0) { listHTML += `<p class="text-sm text-green-400 px-2">暂无已部署任务。</p>`; } 
                else {
                    listHTML += `<ul class="space-y-2 px-2">`;
                    this.mockData.deployedBusinesses.forEach(biz => {
                        let statusClass = '';
                        let statusText = '';
                        if (biz.status === 'running') { statusClass = 'text-green-500'; statusText = '运行中'; }
                        else if (biz.status === 'stopped') { statusClass = 'text-red-500'; statusText = '已停止'; }
                        else if (biz.status === 'pending') { statusClass = 'text-yellow-500'; statusText = '等待中'; }
                        else if (biz.status === 'error') { statusClass = 'text-red-500'; statusText = '有异常'; }
                        else { statusClass = 'text-gray-400'; statusText = biz.status; }
                        const isSelected = biz.business_id === this.selectedBusinessId;
                        listHTML += `<li class="p-2 rounded-md hover:bg-green-900 transition-colors ${isSelected ? 'selected-business-item shadow-md border border-green-500' : 'bg-black shadow-sm hover:shadow-md border border-green-600'}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex-1 cursor-pointer" onclick="app.selectDeployedBusiness('${biz.business_id}')">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-green-400">${biz.business_name}</span>
                                        <span class="text-xs font-semibold ${statusClass}">${statusText}</span>
                                    </div>
                                    <p class="text-xs text-green-300">创建: ${new Date(biz.created_at * 1000).toLocaleString('zh-CN')}</p>
                                    <p class="text-xs text-green-300">更新: ${new Date(biz.updated_at * 1000).toLocaleString('zh-CN')}</p>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-1 mt-2">
                                <button onclick="app.stopBusiness('${biz.business_id}')" class="bg-yellow-600 hover:bg-yellow-700 text-black px-1 py-0.5 rounded text-xs shadow hover:shadow-md transition border border-yellow-400" title="停止">停止</button>
                                <button onclick="app.restartBusiness('${biz.business_id}')" class="bg-green-600 hover:bg-green-700 text-black px-1 py-0.5 rounded text-xs shadow hover:shadow-md transition border border-green-400" title="重启">重启</button>
                                <button onclick="app.deleteDeployedBusiness('${biz.business_id}')" class="bg-red-600 hover:bg-red-700 text-black px-1 py-0.5 rounded text-xs shadow hover:shadow-md transition border border-red-400" title="删除">删除</button>
                            </div>
                        </li>`;
                    });
                    listHTML += `</ul>`;
                }
                listHTML += `</div>`;
                let detailsHTMLContent = '';
                 if (this.selectedBusinessId) { 
                    detailsHTMLContent = await this.renderSelectedBusinessDetails(this.selectedBusinessId); 
                } else { 
                    detailsHTMLContent = `<div class="flex items-center justify-center h-full"><p class="text-gray-500 text-lg"><i class="fas fa-info-circle mr-2"></i>请从左侧列表选择一个业务查看详情。</p></div>`;
                }
                let detailsHTML = `<div class="w-1/2 px-2 overflow-y-auto h-full" id="deployedBusinessDetailsPanel">${detailsHTMLContent}</div>`;
                let serversPanel = `<div class="w-1/4 pl-2 border-l border-green-500 overflow-y-auto h-full">${serversHTML}</div>`;
                return `<div class="bg-black border border-green-500 h-screen flex flex-col"><div class="flex flex-1 overflow-hidden">${listHTML}${detailsHTML}${serversPanel}</div></div>`;
            },
            async selectDeployedBusiness(id) { 
                this.selectedBusinessId = id; 
                const detailsPanel = document.getElementById('deployedBusinessDetailsPanel');
                if (detailsPanel) {
                    detailsPanel.innerHTML = '<p class="text-center text-green-400 py-10">加载业务详情...</p>';
                    detailsPanel.innerHTML = await this.renderSelectedBusinessDetails(id);
                }
                // Re-render list part to update selection highlight, without re-fetching the list
                const listContainer = document.querySelector('#mainContent > div > div > div:first-child'); // More specific selector if needed
                if (listContainer) {
                    let listHTML = `<div class="flex justify-between items-center mb-3 sticky top-0 bg-black py-2 z-10 px-2">
                        <h3 class="text-lg font-semibold text-green-500">任务列表</h3>
                        <div class="flex space-x-1">
                            <button onclick="app.navigateTo('componentTemplates')" class="bg-green-600 hover:bg-green-700 text-black px-2 py-1 rounded text-xs shadow hover:shadow-md transition border border-green-400" title="应用模板">
                                <i class="fas fa-cube mr-1"></i>应用
                            </button>
                            <button onclick="app.navigateTo('businessTemplates')" class="bg-green-600 hover:bg-green-700 text-black px-2 py-1 rounded text-xs shadow hover:shadow-md transition border border-green-400" title="任务模板">
                                <i class="fas fa-layer-group mr-1"></i>任务
                            </button>
                        </div>
                    </div>`;
                    if (this.mockData.deployedBusinesses.length === 0) { listHTML += `<p class="text-sm text-green-400 px-2">暂无已部署任务。</p>`; } 
                    else {
                        listHTML += `<ul class="space-y-2 px-2">`;
                        this.mockData.deployedBusinesses.forEach(biz => {
                            let statusClass = '';
                            let statusText = '';
                            if (biz.status === 'running') { statusClass = 'text-green-500'; statusText = '运行中'; }
                            else if (biz.status === 'stopped') { statusClass = 'text-red-500'; statusText = '已停止'; }
                            else if (biz.status === 'pending') { statusClass = 'text-yellow-500'; statusText = '等待中'; }
                            else if (biz.status === 'error') { statusClass = 'text-red-500'; statusText = '有异常'; }
                            else { statusClass = 'text-gray-400'; statusText = biz.status; }
                            const isSelected = biz.business_id === this.selectedBusinessId;
                            listHTML += `<li class="p-2 rounded-md hover:bg-green-900 transition-colors ${isSelected ? 'selected-business-item shadow-md border border-green-500' : 'bg-black shadow-sm hover:shadow-md border border-green-600'}">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="flex-1 cursor-pointer" onclick="app.selectDeployedBusiness('${biz.business_id}')">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium text-green-400">${biz.business_name}</span>
                                            <span class="text-xs font-semibold ${statusClass}">${statusText}</span>
                                        </div>
                                        <p class="text-xs text-green-300">创建: ${new Date(biz.created_at * 1000).toLocaleString('zh-CN')}</p>
                                        <p class="text-xs text-green-300">更新: ${new Date(biz.updated_at * 1000).toLocaleString('zh-CN')}</p>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-1 mt-2">
                                    <button onclick="app.stopBusiness('${biz.business_id}')" class="bg-yellow-600 hover:bg-yellow-700 text-black px-1 py-0.5 rounded text-xs shadow hover:shadow-md transition border border-yellow-400" title="停止">停止</button>
                                    <button onclick="app.restartBusiness('${biz.business_id}')" class="bg-green-600 hover:bg-green-700 text-black px-1 py-0.5 rounded text-xs shadow hover:shadow-md transition border border-green-400" title="重启">重启</button>
                                    <button onclick="app.deleteDeployedBusiness('${biz.business_id}')" class="bg-red-600 hover:bg-red-700 text-black px-1 py-0.5 rounded text-xs shadow hover:shadow-md transition border border-red-400" title="删除">删除</button>
                                </div>
                            </li>`;
                        });
                        listHTML += `</ul>`;
                    }
                     listContainer.innerHTML = listHTML;
                }
                
                // 同时更新服务器侧边栏
                const serversContainer = document.querySelector('#mainContent > div > div > div:last-child');
                if (serversContainer) {
                    try {
                        const serverResponse = await fetch(`${this.apiUrlPrefix}/nodes`);
                        const serverJsonData = await serverResponse.json();
                        if (serverResponse.ok && serverJsonData.status === 'success') {
                            this.mockData.servers = serverJsonData.nodes || [];
                            serversContainer.innerHTML = this.getServersSidebarHTML();
                        }
                    } catch (error) {
                        console.error("Failed to refresh servers sidebar:", error);
                    }
                }
            },
            async renderSelectedBusinessDetails(id) { 
                if (!id) return '<p class="text-center text-gray-500 py-10">未选择业务。</p>';
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/businesses/${id}`);
                    const jsonData = await response.json();

                    if (response.ok && jsonData.status === 'success' && jsonData.business) {
                        const biz = jsonData.business;
                        let componentsHTML = '无组件信息。';
                        if (biz.components && biz.components.length > 0) {
                             componentsHTML = biz.components.map(c => { 
                                        let statusClass = '';
                    let componentStatusText = '';
                    if (c.status === 'running') { statusClass = 'bg-green-900 text-green-400 border border-green-500'; componentStatusText = '运行中'; }
                    else if (c.status === 'stopped') { statusClass = 'bg-red-900 text-red-400 border border-red-500'; componentStatusText = '已停止'; }
                    else if (c.status === 'pending') { statusClass = 'bg-yellow-900 text-yellow-400 border border-yellow-500'; componentStatusText = '等待中'; }
                    else if (c.status === 'error') { statusClass = 'bg-red-900 text-red-400 border border-red-500'; componentStatusText = '有异常'; }
                    else { statusClass = 'bg-gray-900 text-gray-400 border border-gray-500'; componentStatusText = c.status; } 
                    let envDetail = '';
                    if(c.environment_variables && Object.keys(c.environment_variables).length > 0) {
                        envDetail = `<p class=\"text-xs text-green-300 mt-1\">环境变量: ${JSON.stringify(c.environment_variables)}</p>`;
                    }
                    // 只显示一个操作按钮：running时显示停止，否则显示部署
                    let actionBtn = '';
                    if (c.status === 'running') {
                        actionBtn = `<button onclick=\"app.stopComponent('${biz.business_id}', '${c.component_id}', this)\" class=\"bg-yellow-600 hover:bg-yellow-700 text-black px-1 py-0.5 rounded text-xs ml-2 border border-yellow-400\">停止</button>`;
                    } else {
                        actionBtn = `<button onclick=\"app.deployComponent('${biz.business_id}', '${c.component_id}', this)\" class=\"bg-green-600 hover:bg-green-700 text-black px-1 py-0.5 rounded text-xs ml-2 border border-green-400\">部署</button>`;
                    }
                    // 新增：显示二进制路径或容器名
                    let mainPathOrName = '';
                    if (c.type === 'docker' && c.image_name) {
                        mainPathOrName = `<p class=\"text-xs text-green-300 mt-1\">容器名: ${c.image_name}</p>`;
                    } else if (c.type === 'binary' && c.binary_path) {
                        mainPathOrName = `<p class=\"text-xs text-green-300 mt-1\">二进制路径: ${c.binary_path}</p>`;
                    }
                    return `<li class=\"p-2 border-b border-green-500 last:border-b-0 hover:bg-green-900 rounded-md mb-1 bg-black border border-green-600\">
                        <div class=\"flex justify-between items-center\">
                            <div>
                                <strong class=\"text-green-400\">${c.component_name}</strong>
                                <span class=\"text-xs text-green-300 ml-2\">(类型: ${c.type})</span>
                            </div>
                            <div class=\"flex items-center space-x-2\">
                                <span class=\"px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}\">${componentStatusText}</span>
                                ${actionBtn}
                            </div>
                        </div>
                        ${c.node_id ? `<p class=\"text-xs text-green-300 mt-1\">节点: ${c.node_id} | ${c.type === 'docker' ? '容器ID' : '进程ID'}: ${c.container_id || c.process_id || 'N/A'}</p>` : ''}
                        ${mainPathOrName}
                        ${envDetail}
                    </li>`; 
                }).join('');
                        }
                        return `<h3 class="text-xl font-semibold text-green-500 mb-1 sticky top-0 bg-black py-2 z-10">${biz.business_name}</h3>
                                <h4 class="text-md font-semibold text-green-400 mb-2">应用列表 (${biz.components ? biz.components.length : 0}):</h4>
                                <ul class="list-none bg-black p-2 rounded-md shadow-inner border border-green-500 max-h-80 overflow-y-auto">${componentsHTML}</ul>`;
                    } else {
                        this.showNotification(jsonData.message || '获取业务详情失败', 'error');
                        return '<p class="text-center text-red-400 py-10">加载业务详情失败。</p>';
                    }
                } catch (error) {
                    console.error("Failed to render business details:", error);
                    this.showNotification('渲染业务详情失败: ' + error.message, 'error');
                    return '<p class="text-center text-red-400 py-10">加载业务详情出错。</p>';
                }
            },
            async stopBusiness(id) {  
                const button = event.target.closest('button');
                if(button) { button.classList.add('button-loading'); button.disabled = true; }
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/businesses/${id}/stop`, { method: 'POST' });
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success') {
                        this.showNotification(jsonData.message, 'success');
                        this.renderPageContent('deployedBusinesses'); 
                    } else {
                        this.showNotification(jsonData.message || '停止业务失败', 'error');
                    }
                } catch (error) {
                     this.showNotification('停止业务请求失败: ' + error.message, 'error');
                } finally {
                    if(button) { button.classList.remove('button-loading'); button.disabled = false; }
                }
            },
            async restartBusiness(id) { 
                const button = event.target.closest('button');
                if(button) { button.classList.add('button-loading'); button.disabled = true; }
                 try {
                    const response = await fetch(`${this.apiUrlPrefix}/businesses/${id}/restart`, { method: 'POST' });
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success') {
                        this.showNotification(jsonData.message, 'success');
                         this.renderPageContent('deployedBusinesses');
                    } else {
                        this.showNotification(jsonData.message || '重启业务失败', 'error');
                    }
                } catch (error) {
                     this.showNotification('重启业务请求失败: ' + error.message, 'error');
                } finally {
                    if(button) { button.classList.remove('button-loading'); button.disabled = false; }
                }
            },
            deleteDeployedBusiness(id) { 
                const biz = this.mockData.deployedBusinesses.find(b=>b.business_id === id); 
                this.openModal( '确认删除部署', `<p>确定要删除已部署的业务 <strong>${biz ? biz.business_name : id}</strong> 吗？</p><p class="text-sm text-red-600 mt-2">此操作将取消部署且无法撤销。</p>`, 
                [ 
                    { label: '确认删除', action: () => this._confirmDeleteDeployedBusiness(id), class: 'bg-red-600 hover:bg-red-700 text-white' }, 
                    { label: '取消', action: () => this.closeModal(), class: 'bg-gray-300 hover:bg-gray-400 text-gray-800' }
                ]);
            },
            async _confirmDeleteDeployedBusiness(id) { 
                const deleteButtonInConfirmModal = document.getElementById('modal_btn_确认删除');
                if(deleteButtonInConfirmModal) { deleteButtonInConfirmModal.classList.add('button-loading'); deleteButtonInConfirmModal.disabled = true;}

                try {
                    const response = await fetch(`${this.apiUrlPrefix}/businesses/${id}`, { method: 'DELETE'});
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success') {
                        this.showNotification(jsonData.message || '已部署业务已删除', 'success');
                        this.selectedBusinessId = null; 
                        this.closeModal(); 
                        this.renderPageContent('deployedBusinesses'); 
                    } else {
                        this.showNotification(jsonData.message || '删除已部署业务失败', 'error');
                        if(deleteButtonInConfirmModal) { deleteButtonInConfirmModal.classList.remove('button-loading'); deleteButtonInConfirmModal.disabled = false;}
                    }
                } catch(error) {
                    this.showNotification('删除已部署业务请求失败: ' + error.message, 'error');
                     if(deleteButtonInConfirmModal) { deleteButtonInConfirmModal.classList.remove('button-loading'); deleteButtonInConfirmModal.disabled = false;}
                }
            },

            // --- Server/Node Monitoring (Page View) ---
            getServersPageHTML() { 
                let content = `<div class="bg-white p-6 rounded-lg shadow-lg">
                                <h2 class="text-2xl font-semibold text-sky-700 mb-6">服务器监控</h2>
                                <div class="table-responsive">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">主机名</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP地址</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPU型号</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GPU数量</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最后心跳</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">`;
                
                if (this.mockData.servers.length === 0) {
                    content += `<tr><td colspan="7" class="text-center text-gray-500 py-10">暂无服务器信息。</td></tr>`;
                } else {
                    this.mockData.servers.forEach(server => {
                        let statusClass = server.status === 'online' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        content += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                        ${server.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${server.hostname}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${server.ip_address}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 truncate max-w-xs" title="${server.cpu_model}">${server.cpu_model || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${server.gpu_count !== undefined ? server.gpu_count : 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${new Date(server.updated_at * 1000).toLocaleString('zh-CN')}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="app.showServerDetails('${server.node_id}')" class="text-sky-600 hover:text-sky-800" title="查看详情"><i class="fas fa-info-circle"></i></button>
                                </td>
                            </tr>`;
                    });
                }
                content += `</tbody></table></div></div>`;
                return content;
            },

            // --- Server Sidebar for Combined View ---
            getServersSidebarHTML() {
                let content = `<div class="flex justify-between items-center mb-3 sticky top-0 bg-black py-2 z-10 px-2">
                    <h3 class="text-lg font-semibold text-green-500">服务器状态</h3>
                    <button id="autoRefreshButton" onclick="app.toggleAutoRefresh()" class="bg-green-600 hover:bg-green-700 text-black px-2 py-1 rounded text-xs shadow hover:shadow-md transition border border-green-400" title="自动刷新">
                        <i class="fas fa-sync-alt mr-1"></i>停止
                    </button>
                </div>`;
                
                if (this.mockData.servers.length === 0) {
                    content += `<p class="text-sm text-green-400 px-2">暂无服务器信息。</p>`;
                } else {
                    content += `<div class="space-y-2 px-2">`;
                    this.mockData.servers.forEach(server => {
                        let statusClass = server.status === 'online' ? 'text-green-500' : 'text-red-500';
                        let statusText = server.status === 'online' ? '在线' : '离线';
                        
                        content += `
                            <div class="p-2 bg-black border border-green-600 rounded-md shadow-sm hover:shadow-md transition-colors cursor-pointer" onclick="app.showServerDetails('${server.node_id}')">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-green-400 text-sm truncate" title="${server.ip_address}">${server.ip_address}</span>
                                    <span class="text-xs font-semibold ${statusClass}">${statusText}</span>
                                </div>
                            </div>`;
                    });
                    content += `</div>`;
                }
                return content;
            },
            async showServerDetails(nodeId) { 
                const modalBody = document.getElementById('modalBody');
                this.openModal(`服务器详情: 加载中...`, '<p class="text-center text-gray-500 py-5">加载详情...</p>');
                
                try {
                    const response = await fetch(`${this.apiUrlPrefix}/nodes/${nodeId}`);
                    const jsonData = await response.json();

                    if (response.ok && jsonData.status === 'success' && jsonData.node) {
                        const server = jsonData.node;
                        let cpuDetailsHTML = '无CPU信息';
                        if (server.latest_cpu) {
                            const cpu = server.latest_cpu;
                            cpuDetailsHTML = `
                                <p><strong>使用率:</strong> ${parseFloat(cpu.usage_percent).toFixed(2)}%</p>
                                <p><strong>核心数:</strong> ${cpu.core_count}</p>
                                <p><strong>1分钟负载:</strong> ${cpu.load_avg_1m}</p>
                                <p><strong>5分钟负载:</strong> ${cpu.load_avg_5m}</p>
                                <p><strong>15分钟负载:</strong> ${cpu.load_avg_15m}</p>
                                <p><strong>时间戳:</strong> ${new Date(cpu.timestamp * 1000).toLocaleString('zh-CN')}</p>
                            `;
                        }
                        let memoryDetailsHTML = '无内存信息';
                        if (server.latest_memory) {
                            const mem = server.latest_memory;
                            memoryDetailsHTML = `
                                <p><strong>使用率:</strong> ${parseFloat(mem.usage_percent).toFixed(2)}%</p>
                                <p><strong>总量:</strong> ${(mem.total / (1024**3)).toFixed(2)} GB</p>
                                <p><strong>已用:</strong> ${(mem.used / (1024**3)).toFixed(2)} GB</p>
                                <p><strong>空闲:</strong> ${(mem.free / (1024**3)).toFixed(2)} GB</p>
                                <p><strong>时间戳:</strong> ${new Date(mem.timestamp * 1000).toLocaleString('zh-CN')}</p>
                            `;
                        }

                        let detailsHTML = `<div class="space-y-4">
                            <p><strong>节点ID:</strong> ${server.node_id}</p>
                            <p><strong>主机名:</strong> ${server.hostname}</p>
                            <p><strong>IP地址:</strong> ${server.ip_address}</p>
                            <p><strong>操作系统:</strong> ${server.os_info || 'N/A'}</p>
                            <p><strong>CPU型号:</strong> ${server.cpu_model || 'N/A'}</p>
                            <p><strong>GPU数量:</strong> ${server.gpu_count !== undefined ? server.gpu_count : 'N/A'}</p>
                            <p><strong>状态:</strong> <span class="font-semibold ${server.status === 'online' ? 'text-green-600' : 'text-red-600'}">${server.status}</span></p>
                            <p><strong>注册时间:</strong> ${new Date(server.created_at * 1000).toLocaleString('zh-CN')}</p>
                            <p><strong>最后心跳:</strong> ${new Date(server.updated_at * 1000).toLocaleString('zh-CN')}</p>
                            
                            <div class="mt-4">
                                <h4 class="text-md font-semibold mb-2">CPU最近状态</h4>
                                <div class="bg-gray-50 p-3 rounded-md text-sm">${cpuDetailsHTML}</div>
                            </div>

                            <div class="mt-4">
                                <h4 class="text-md font-semibold mb-2">内存最近状态</h4>
                                <div class="bg-gray-50 p-3 rounded-md text-sm">${memoryDetailsHTML}</div>
                            </div>
                        </div>`;
                        document.getElementById('modalTitle').textContent = `服务器详情: ${server.hostname}`;
                        modalBody.innerHTML = detailsHTML;
                    } else {
                        this.showNotification(jsonData.message || '获取服务器详情失败', 'error');
                        modalBody.innerHTML = '<p class="text-center text-red-500 py-5">加载详情失败。</p>';
                    }
                } catch (error) {
                    console.error("Failed to fetch server details:", error);
                    this.showNotification('获取服务器详情请求失败: ' + error.message, 'error');
                    modalBody.innerHTML = '<p class="text-center text-red-500 py-5">加载详情失败。</p>';
                }
            },

            // --- Initialization ---
            init() {
                this.navigateTo(this.currentView); 
                // 启动自动刷新
                if (this.autoRefreshEnabled) {
                    this.startAutoRefresh();
                }
            },

            // 添加自动刷新控制方法
            toggleAutoRefresh() {
                this.autoRefreshEnabled = !this.autoRefreshEnabled;
                if (this.autoRefreshEnabled) {
                    this.startAutoRefresh();
                } else {
                    this.stopAutoRefresh();
                }
                // 更新按钮状态
                const refreshButton = document.getElementById('autoRefreshButton');
                if (refreshButton) {
                    refreshButton.innerHTML = this.autoRefreshEnabled ? 
                        '<i class="fas fa-sync-alt mr-1"></i>停止自动刷新' : 
                        '<i class="fas fa-sync-alt mr-1"></i>开启自动刷新';
                    refreshButton.classList.toggle('bg-green-500', this.autoRefreshEnabled);
                    refreshButton.classList.toggle('bg-gray-500', !this.autoRefreshEnabled);
                }
            },

            startAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                }
                this.autoRefreshInterval = setInterval(() => {
                    if (this.currentView === 'deployedBusinesses') {
                        this.renderPageContent('deployedBusinesses');
                    } else if (this.currentView === 'servers') {
                        this.renderPageContent('servers');
                    }
                }, this.refreshInterval);
            },

            stopAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                    this.autoRefreshInterval = null;
                }
            },

            async deployComponent(businessId, componentId, btn) {
                if (btn) { btn.disabled = true; btn.classList.add('button-loading'); }
                try {
                    const response = await fetch(`/api/businesses/${businessId}/components/${componentId}/deploy`, { method: 'POST' });
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success') {
                        this.showNotification(jsonData.message || '组件部署成功', 'success');
                        this.renderPageContent('deployedBusinesses');
                    } else {
                        this.showNotification(jsonData.message || '组件部署失败', 'error');
                    }
                } catch (error) {
                    this.showNotification('组件部署请求失败: ' + error.message, 'error');
                } finally {
                    if (btn) { btn.disabled = false; btn.classList.remove('button-loading'); }
                }
            },
            async stopComponent(businessId, componentId, btn) {
                if (btn) { btn.disabled = true; btn.classList.add('button-loading'); }
                try {
                    const response = await fetch(`/api/businesses/${businessId}/components/${componentId}/stop`, { method: 'POST' });
                    const jsonData = await response.json();
                    if (response.ok && jsonData.status === 'success') {
                        this.showNotification(jsonData.message || '组件已停止', 'success');
                        this.renderPageContent('deployedBusinesses');
                    } else {
                        this.showNotification(jsonData.message || '停止组件失败', 'error');
                    }
                } catch (error) {
                    this.showNotification('停止组件请求失败: ' + error.message, 'error');
                } finally {
                    if (btn) { btn.disabled = false; btn.classList.remove('button-loading'); }
                }
            },
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>
