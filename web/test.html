<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务器监控仪表盘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1E1E1E;
            color: #D4D4D4;
            font-size: 13px; /* 基础字体大小 */
        }
        .font-mono {
            font-family: 'Source Code Pro', monospace;
        }
        /* 自定义滚动条样式以匹配VS Code风格 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #252526;
        }
        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-online, .status-running { background-color: #33CC66; }
        .status-offline, .status-failed { background-color: #FF5555; }
        .status-warning { background-color: #FFC107; }

        /* Tab 样式 */
        .tab-button.active {
            border-color: #007ACC;
            color: #FFFFFF;
            background-color: #252526;
        }
        
        /* 模态框和通知的过渡效果 */
        .modal, .notification {
            transition: opacity 0.3s ease-in-out;
        }

        /* 表单样式 */
        .form-input {
            background-color: #3C3C3C;
            border: 1px solid #3C3C3C;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 13px;
            color: #D4D4D4;
            width: 100%;
        }
        .form-input:focus {
            outline: none;
            border-color: #007ACC;
        }
        .form-label {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            display: block;
        }
        
    </style>
</head>
<body class="antialiased">
    <div class="h-screen flex flex-col">
        <!-- 顶部导航栏 -->
        <header class="bg-[#3C3C3C] shadow-md p-3 flex justify-between items-center sticky top-0 z-20 flex-shrink-0">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[#007ACC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                </svg>
                <h1 class="text-lg font-semibold text-gray-100">集群监控仪表盘</h1>
            </div>
            <div class="flex items-center space-x-3">
                <div class="text-xs text-gray-400">
                    最后更新: <span id="last-updated">--:--:--</span>
                </div>
                <button id="create-template-btn" class="p-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition-colors flex items-center space-x-2 text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>创建模板</span>
                </button>
                <button id="deploy-template-btn" class="p-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition-colors flex items-center space-x-2 text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>部署模板</span>
                </button>
                <button id="refresh-btn" class="p-2 rounded-md bg-gray-700 hover:bg-[#007ACC] text-gray-300 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4l-4 4M4 20l4-4" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- 主容器 -->
        <div class="flex-grow flex overflow-hidden">
            <!-- 左侧服务器列表 -->
            <aside class="w-60 flex-shrink-0 bg-[#252526] flex flex-col">
                <h2 class="text-base font-semibold p-3 border-b border-gray-700 text-gray-200 flex items-center">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#007ACC]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    服务器节点
                </h2>
                <ul id="server-list" class="flex-grow p-2 space-y-1 overflow-y-auto">
                    <!-- 服务器列表将通过JS动态插入 -->
                </ul>
            </aside>

            <!-- 右侧主内容区 - 任务列表 -->
            <main class="flex-grow p-4 md:p-6 overflow-y-auto flex flex-col">
                <h2 class="text-xl font-semibold mb-3 text-gray-200 flex items-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-[#007ACC]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    运行中的任务
                </h2>
                <!-- Tab 容器 -->
                <div class="flex-grow flex flex-col">
                    <!-- Tab 按钮 -->
                    <div id="task-tabs" class="flex border-b border-gray-700 flex-shrink-0 overflow-x-auto">
                        <!-- Tab 按钮将通过JS动态插入 -->
                    </div>
                    <!-- **FIXED**: 单一的应用列表内容面板 -->
                    <div id="app-content-panel" class="bg-[#252526] rounded-b-lg flex-grow">
                        <!-- 应用列表将动态渲染到这里 -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- 部署模板模态框 -->
    <div id="deploy-template-modal" class="modal fixed inset-0 bg-black/60 z-30 hidden items-center justify-center opacity-0">
        <div class="bg-[#252526] rounded-lg shadow-xl w-full max-w-xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-3 border-b border-gray-700">
                <h3 class="text-base font-semibold">部署任务模板</h3>
                <button class="close-modal-btn p-1 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="deploy-template-list-container" class="p-3 overflow-y-auto">
                <!-- 模板列表将通过JS动态插入 -->
            </div>
        </div>
    </div>

    <!-- 创建模板模态框 -->
    <div id="create-template-modal" class="modal fixed inset-0 bg-black/60 z-30 hidden items-center justify-center opacity-0">
        <div class="bg-[#252526] rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-3 border-b border-gray-700">
                <h3 class="text-base font-semibold">创建模板</h3>
                <button class="close-modal-btn p-1 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-shrink-0 border-b border-gray-700">
                <nav id="create-modal-tabs" class="flex space-x-4 px-3">
                    <button class="tab-button active py-2 px-3 text-sm font-medium" data-target="create-app-panel">创建应用模板</button>
                    <button class="tab-button py-2 px-3 text-sm font-medium" data-target="create-task-panel">创建任务模板</button>
                </nav>
            </div>
            <div class="p-4 overflow-y-auto flex-grow">
                <!-- 创建应用模板面板 -->
                <div id="create-app-panel" class="tab-panel active">
                    <form id="create-app-template-form" class="space-y-4">
                        <div>
                            <label class="form-label" for="app-template-name">模板名称</label>
                            <input type="text" id="app-template-name" name="template_name" class="form-input" required>
                        </div>
                        <div>
                            <label class="form-label" for="app-template-desc">描述</label>
                            <input type="text" id="app-template-desc" name="description" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">类型</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center"><input type="radio" name="type" value="docker" class="mr-2" checked>Docker</label>
                                <label class="flex items-center"><input type="radio" name="type" value="binary" class="mr-2">Binary</label>
                            </div>
                        </div>
                        <div id="docker-config-fields">
                            <label class="form-label" for="app-image-name">镜像名称</label>
                            <input type="text" id="app-image-name" name="image_name" class="form-input" placeholder="例如: nginx:latest">
                        </div>
                        <div id="binary-config-fields" class="hidden">
                            <label class="form-label" for="app-binary-path">二进制文件路径</label>
                            <input type="text" id="app-binary-path" name="binary_path" class="form-input" placeholder="例如: /usr/local/bin/app">
                        </div>
                        <div>
                            <label class="form-label" for="app-affinity-ip">亲和性IP (可选)</label>
                            <input type="text" id="app-affinity-ip" name="affinity_ip" class="form-input" placeholder="例如: 172.17.0.2">
                        </div>
                        <div class="pt-2">
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded text-sm transition-colors disabled:bg-gray-500">创建应用模板</button>
                        </div>
                    </form>
                </div>
                <!-- 创建任务模板面板 -->
                <div id="create-task-panel" class="tab-panel">
                    <form id="create-task-template-form" class="space-y-4">
                        <div>
                            <label class="form-label" for="task-template-name">模板名称</label>
                            <input type="text" id="task-template-name" name="template_name" class="form-input" required>
                        </div>
                        <div>
                            <label class="form-label" for="task-template-desc">描述</label>
                            <input type="text" id="task-template-desc" name="description" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">选择应用组件</label>
                            <div id="component-template-checklist" class="max-h-48 overflow-y-auto bg-[#3C3C3C] p-2 rounded space-y-2">
                                <!-- 组件模板列表将动态加载 -->
                            </div>
                        </div>
                        <div class="pt-2">
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded text-sm transition-colors disabled:bg-gray-500">创建任务模板</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- 通知组件 -->
    <div id="notification" class="notification fixed bottom-4 right-4 z-40 hidden opacity-0">
        <!-- 通知内容将通过JS动态插入 -->
    </div>


    <script>
        // --- 全局状态 ---
        let nodeMap = new Map(); // 用于存储 node_id -> ip_address 的映射

        // --- DOM 元素 ---
        const serverList = document.getElementById('server-list');
        const taskTabsContainer = document.getElementById('task-tabs');
        const appContentPanel = document.getElementById('app-content-panel'); // **FIXED**: Get the single panel
        const lastUpdatedSpan = document.getElementById('last-updated');
        const refreshBtn = document.getElementById('refresh-btn');
        
        // 部署模板相关
        const deployTemplateBtn = document.getElementById('deploy-template-btn');
        const deployTemplateModal = document.getElementById('deploy-template-modal');
        const deployTemplateListContainer = document.getElementById('deploy-template-list-container');
        
        // 创建模板相关
        const createTemplateBtn = document.getElementById('create-template-btn');
        const createTemplateModal = document.getElementById('create-template-modal');
        const createModalTabs = document.getElementById('create-modal-tabs');
        const componentTemplateChecklist = document.getElementById('component-template-checklist');
        const createAppTemplateForm = document.getElementById('create-app-template-form');
        const createTaskTemplateForm = document.getElementById('create-task-template-form');

        const closeModalBtns = document.querySelectorAll('.close-modal-btn');

        // --- 帮助函数 ---
        // 根据状态返回对应的SVG图标
        const getStatusIcon = (status) => {
            switch (status) {
                case 'running':
                    return `<svg title="Running" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                default:
                    return `<svg title="状态: ${status}" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            }
        };
        
        // 显示通知
        const showNotification = (message, type = 'success') => {
            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            notification.innerHTML = `<div class="${bgColor} text-white text-sm font-semibold rounded-lg px-4 py-2 shadow-lg">${message}</div>`;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.remove('opacity-0'), 10); // Fade in
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.classList.add('hidden'), 300); // Fade out
            }, 3000);
        };

        // --- API & 渲染函数 ---

        // 从API获取并渲染服务器列表
        async function fetchAndRenderServers() {
            serverList.innerHTML = `<li class="p-2 text-xs text-gray-400">正在加载...</li>`;
            nodeMap.clear(); // 清空旧的映射
            try {
                const response = await fetch('http://localhost:38080/api/nodes');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.status !== 'success' || !Array.isArray(data.nodes)) {
                    throw new Error('Invalid API response format for nodes');
                }
                
                serverList.innerHTML = ''; // 清空加载提示
                if (data.nodes.length === 0) {
                    serverList.innerHTML = `<li class="p-2 text-xs text-gray-400">未找到任何节点。</li>`;
                    return;
                }

                data.nodes.forEach(node => {
                    nodeMap.set(node.node_id, node.ip_address); // 填充映射
                    const statusClass = node.status === 'online' ? 'status-online' : 'status-offline';
                    const serverItem = `
                        <li title="${node.hostname}" class="flex justify-between items-center p-2 rounded-md hover:bg-gray-700/50 cursor-pointer transition-colors">
                            <span class="text-xs font-medium font-mono">${node.ip_address}</span>
                            <div class="status-dot ${statusClass}"></div>
                        </li>
                    `;
                    serverList.innerHTML += serverItem;
                });

            } catch (error) {
                console.error("无法获取服务器节点:", error);
                serverList.innerHTML = `<li class="p-2 text-xs text-red-400">加载节点失败。</li>`;
            }
        }

        // 从API获取并渲染任务列表（Tab按钮）
        async function fetchAndRenderTasks() {
            taskTabsContainer.innerHTML = `<div class="p-2 text-xs text-gray-400">正在加载任务...</div>`;
            appContentPanel.innerHTML = ''; // **FIXED**: Clear the single panel
            try {
                const response = await fetch('http://localhost:38080/api/businesses');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.status !== 'success' || !Array.isArray(data.businesses)) {
                    throw new Error('Invalid API response format for businesses');
                }
                
                taskTabsContainer.innerHTML = ''; // 清空加载提示
                if (data.businesses.length === 0) {
                    taskTabsContainer.innerHTML = `<div class="p-2 text-xs text-gray-400">未找到任何运行中的任务。</div>`;
                    return;
                }

                data.businesses.forEach((business) => {
                    // 创建 Tab 按钮
                    const statusClass = business.status === 'running' ? 'status-running' : 'status-failed';
                    const tabButton = document.createElement('button');
                    tabButton.className = 'task-tab-button flex-shrink-0 flex items-center space-x-2 font-mono text-xs px-3 py-2 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors';
                    tabButton.innerHTML = `<div class="status-dot ${statusClass}"></div><span title="${business.business_id}">${business.business_name}</span>`;
                    tabButton.dataset.businessId = business.business_id; // 存储ID用于后续请求
                    tabButton.onclick = () => selectTab(business.business_id);
                    taskTabsContainer.appendChild(tabButton);
                });

                // 默认选中并加载第一个 Tab
                if (data.businesses.length > 0) {
                    const firstTab = document.querySelector('.task-tab-button');
                    if (firstTab) {
                        selectTab(firstTab.dataset.businessId);
                    }
                }

            } catch (error) {
                console.error("无法获取任务列表:", error);
                taskTabsContainer.innerHTML = `<div class="p-2 text-xs text-red-400">加载任务失败。</div>`;
            }
        }

        // 获取并渲染指定任务下的应用列表
        async function fetchAndRenderApps(businessId) {
            appContentPanel.innerHTML = `<div class="p-3 text-xs text-gray-400">正在加载应用...</div>`;
            try {
                const response = await fetch(`http://localhost:38080/api/businesses/${businessId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.status !== 'success' || !data.business || !Array.isArray(data.business.components)) {
                     throw new Error('Invalid API response format for business details');
                }

                const apps = data.business.components;
                
                if (apps.length === 0) {
                    appContentPanel.innerHTML = `<div class="p-3 text-xs text-gray-400">此任务下没有应用。</div>`;
                    return;
                }

                const appDetails = apps.map(app => {
                    const appStatusIcon = getStatusIcon(app.status);
                    const appTypeText = (app.type === 'docker' || app.type === 'container') ? 
                       `<svg title="Container" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-14L4 7m0 10l8 4m0 0l8-4m-8 4V7" /></svg>` :
                       `<svg title="Binary" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>`;
                    const nodeIp = nodeMap.get(app.node_id) || app.node_id; // 从映射中查找IP

                    let sourceInfo, instanceInfo;
                    if (app.type === 'binary') {
                        sourceInfo = `<div class="font-mono text-gray-300 truncate" title="${app.binary_path || ''}">${app.binary_path || '-'}</div>`;
                        instanceInfo = `<div class="font-mono text-gray-300 truncate" title="${app.process_id || ''}">${app.process_id || '-'}</div>`;
                    } else { // container or docker
                        sourceInfo = `<div class="font-mono text-gray-300 truncate" title="${app.image_name || ''}">${app.image_name || '-'}</div>`;
                        instanceInfo = `<div class="font-mono text-gray-300 truncate" title="${app.container_id || ''}">${app.container_id || '-'}</div>`;
                    }

                    return `
                        <div class="grid grid-cols-12 gap-4 items-center py-2 px-3 text-xs hover:bg-gray-800/20 rounded-md">
                            <div class="col-span-1 flex justify-center">${appTypeText}</div>
                            <div class="col-span-2 font-mono text-gray-300 truncate" title="${app.component_id}">${app.component_name}</div>
                            <div class="col-span-2 flex items-center justify-center">
                                ${appStatusIcon}
                            </div>
                            <div class="col-span-2 font-mono text-gray-400">${nodeIp}</div>
                            <div class="col-span-3">${sourceInfo}</div>
                            <div class="col-span-2">${instanceInfo}</div>
                        </div>
                    `;
                }).join('');

                appContentPanel.innerHTML = `
                    <div class="p-3">
                        <div class="grid grid-cols-12 gap-4 items-center pb-2 px-3 text-[11px] font-bold text-gray-400 border-b border-gray-600">
                            <div class="col-span-1 text-center">类型</div>
                            <div class="col-span-2">应用名称</div>
                            <div class="col-span-2 text-center">状态</div>
                            <div class="col-span-2">所在节点</div>
                            <div class="col-span-3">来源 (路径/镜像)</div>
                            <div class="col-span-2">实例 ID (进程/容器)</div>
                        </div>
                        <div class="pt-2 space-y-1">
                            ${appDetails}
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error(`无法获取应用列表 for business ${businessId}:`, error);
                appContentPanel.innerHTML = `<div class="p-3 text-xs text-red-400">加载应用失败。</div>`;
            }
        }

        // **FIXED**: 切换 Tab 的核心逻辑
        function selectTab(businessId) {
            if (!businessId) return;
            
            // Deactivate all tabs
            const allTabs = document.querySelectorAll('.task-tab-button');
            allTabs.forEach(tab => tab.classList.remove('active'));
            
            // Activate the selected tab by its data attribute
            const targetTab = document.querySelector(`.task-tab-button[data-business-id="${businessId}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // Always re-fetch data for the selected tab into the single panel
            fetchAndRenderApps(businessId);
        }
        
        function updateTimestamp() {
            lastUpdatedSpan.textContent = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        }

        async function initializeApp() {
            updateTimestamp();
            // 必须先获取节点映射，再获取任务
            await fetchAndRenderServers();
            await fetchAndRenderTasks();
        }
        
        // --- 部署模板功能 ---
        
        // 打开部署模态框并加载模板
        async function openDeployTemplateModal() {
            deployTemplateModal.classList.remove('hidden');
            setTimeout(() => deployTemplateModal.classList.remove('opacity-0'), 10);
            
            deployTemplateListContainer.innerHTML = `<div class="p-3 text-xs text-gray-400">正在加载模板...</div>`;
            
            try {
                const response = await fetch('http://localhost:38080/api/templates/businesses');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                if (data.status !== 'success' || !Array.isArray(data.templates)) {
                    throw new Error('Invalid API response for templates');
                }
                
                deployTemplateListContainer.innerHTML = '';
                if (data.templates.length === 0) {
                    deployTemplateListContainer.innerHTML = `<div class="p-3 text-xs text-gray-400">没有可用的模板。</div>`;
                    return;
                }

                const templateItems = data.templates.map(template => `
                    <div class="flex items-center justify-between p-3 border-b border-gray-700 last:border-b-0">
                        <div>
                            <h4 class="font-semibold text-sm text-gray-200">${template.template_name}</h4>
                            <p class="text-xs text-gray-400">${template.description}</p>
                        </div>
                        <button class="deploy-button bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded text-xs transition-colors disabled:bg-gray-500" data-template-id="${template.business_template_id}">
                            部署
                        </button>
                    </div>
                `).join('');
                deployTemplateListContainer.innerHTML = templateItems;

            } catch (error) {
                console.error("无法加载模板列表:", error);
                deployTemplateListContainer.innerHTML = `<div class="p-3 text-xs text-red-400">加载模板失败。</div>`;
            }
        }

        // 部署模板
        async function deployTemplate(event) {
            const button = event.target.closest('.deploy-button');
            if (!button) return;

            const templateId = button.dataset.templateId;
            button.disabled = true;
            button.textContent = '部署中...';

            try {
                const response = await fetch(`http://localhost:38080/api/businesses/template/${templateId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (!response.ok || result.status !== 'success') {
                    throw new Error(result.message || '部署失败');
                }
                
                showNotification(`模板部署成功!`);
                closeModal(deployTemplateModal);
                setTimeout(initializeApp, 1000);

            } catch (error) {
                console.error("部署模板失败:", error);
                showNotification(`部署失败: ${error.message}`, 'error');
                button.disabled = false;
                button.textContent = '部署';
            }
        }

        // --- 创建模板功能 ---
        function openCreateTemplateModal() {
            createTemplateModal.classList.remove('hidden');
            setTimeout(() => createTemplateModal.classList.remove('opacity-0'), 10);
            // 默认显示第一个tab
            switchCreateModalTab(document.querySelector('#create-modal-tabs .tab-button'));
        }

        function switchCreateModalTab(targetButton) {
            const tabs = createModalTabs.querySelectorAll('.tab-button');
            const panels = createTemplateModal.querySelectorAll('.tab-panel');
            const targetPanelId = targetButton.dataset.target;
            
            tabs.forEach(t => t.classList.remove('active'));
            targetButton.classList.add('active');
            
            panels.forEach(p => p.classList.remove('active'));
            document.getElementById(targetPanelId).classList.add('active');

            // 如果切换到创建任务模板，则加载组件列表
            if (targetPanelId === 'create-task-panel') {
                fetchAndRenderComponentTemplatesForForm();
            }
        }

        async function fetchAndRenderComponentTemplatesForForm() {
            componentTemplateChecklist.innerHTML = `<div class="text-xs text-gray-400">正在加载组件模板...</div>`;
            try {
                const response = await fetch('http://localhost:38080/api/templates/components');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.status !== 'success' || !Array.isArray(data.templates)) {
                    throw new Error('Invalid API response for component templates');
                }
                
                componentTemplateChecklist.innerHTML = '';
                if (data.templates.length === 0) {
                     componentTemplateChecklist.innerHTML = `<div class="text-xs text-gray-400">没有可用的组件模板。</div>`;
                     return;
                }
                
                const checklistItems = data.templates.map(template => `
                    <label class="flex items-center p-2 hover:bg-gray-700/50 rounded cursor-pointer">
                        <input type="checkbox" name="components" value="${template.component_template_id}" class="mr-3">
                        <div>
                            <div class="text-sm text-gray-200">${template.template_name} <span class="text-xs text-gray-500">(${template.type})</span></div>
                            <div class="text-xs text-gray-400">${template.description}</div>
                        </div>
                    </label>
                `).join('');
                componentTemplateChecklist.innerHTML = checklistItems;

            } catch (error) {
                console.error("加载组件模板列表失败:", error);
                componentTemplateChecklist.innerHTML = `<div class="text-xs text-red-400">加载组件模板失败。</div>`;
            }
        }

        async function handleCreateAppTemplate(event) {
            event.preventDefault();
            const form = event.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = '创建中...';
            
            const formData = new FormData(form);
            const data = {
                template_name: formData.get('template_name'),
                description: formData.get('description'),
                type: formData.get('type'),
                config: {
                    affinity: {} // **FIX**: Always include affinity object
                }
            };

            if (data.type === 'docker') {
                data.config.image_name = formData.get('image_name');
            } else {
                data.config.binary_path = formData.get('binary_path');
            }
            const affinityIp = formData.get('affinity_ip');
            if (affinityIp) {
                data.config.affinity.ip_address = affinityIp;
            }

            try {
                const response = await fetch('http://localhost:38080/api/templates/components', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok || result.status !== 'success') {
                    throw new Error(result.message || '创建失败');
                }
                showNotification('应用模板创建成功!');
                closeModal(createTemplateModal);
                form.reset();
            } catch (error) {
                showNotification(`创建失败: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '创建应用模板';
            }
        }
        
        async function handleCreateTaskTemplate(event) {
            event.preventDefault();
            const form = event.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = '创建中...';

            const formData = new FormData(form);
            const selectedComponents = Array.from(form.querySelectorAll('input[name="components"]:checked'))
                                            .map(cb => ({ component_template_id: cb.value }));

            if (selectedComponents.length === 0) {
                showNotification('请至少选择一个应用组件', 'error');
                button.disabled = false;
                button.textContent = '创建任务模板';
                return;
            }

            const data = {
                template_name: formData.get('template_name'),
                description: formData.get('description'),
                components: selectedComponents
            };

            try {
                const response = await fetch('http://localhost:38080/api/templates/businesses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok || result.status !== 'success') {
                    throw new Error(result.message || '创建失败');
                }
                showNotification('任务模板创建成功!');
                closeModal(createTemplateModal);
                form.reset();
            } catch (error) {
                showNotification(`创建失败: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '创建任务模板';
            }
        }
        
        function closeModal(modalElement) {
            modalElement.classList.add('opacity-0');
            setTimeout(() => modalElement.classList.add('hidden'), 300);
        }

        // --- 事件监听 ---
        refreshBtn.addEventListener('click', initializeApp);
        
        // 部署模板
        deployTemplateBtn.addEventListener('click', openDeployTemplateModal);
        deployTemplateListContainer.addEventListener('click', deployTemplate);
        
        // 创建模板
        createTemplateBtn.addEventListener('click', openCreateTemplateModal);
        createModalTabs.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-button')) {
                switchCreateModalTab(e.target);
            }
        });
        createAppTemplateForm.addEventListener('submit', handleCreateAppTemplate);
        createTaskTemplateForm.addEventListener('submit', handleCreateTaskTemplate);
        
        // 应用类型切换
        createAppTemplateForm.querySelectorAll('input[name="type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isDocker = e.target.value === 'docker';
                document.getElementById('docker-config-fields').classList.toggle('hidden', !isDocker);
                document.getElementById('binary-config-fields').classList.toggle('hidden', isDocker);
            });
        });

        // 关闭模态框
        closeModalBtns.forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));
        deployTemplateModal.addEventListener('click', (e) => { if (e.target === deployTemplateModal) closeModal(deployTemplateModal); });
        createTemplateModal.addEventListener('click', (e) => { if (e.target === createTemplateModal) closeModal(createTemplateModal); });


        document.addEventListener('DOMContentLoaded', initializeApp);
        setInterval(initializeApp, 30000);
    </script>
</body>
</html>
